# E2E Tests with Playwright

End-to-end tests for ContraVento application using Playwright Test.

## Test Coverage

### Authentication (auth.spec.ts)
- User registration flow (T046)
- Login/logout flows (T047)
- Session persistence (T048)
- Protected routes access control

### Trip Creation (trip-creation.spec.ts)
- 4-step wizard workflow (T049-T050)
  - Step 1: Basic trip information
  - Step 2: Story and tags
  - Step 3: Photo uploads
  - Step 4: Review and publish
- Draft vs. published trips
- Form validation

### Public Feed (public-feed.spec.ts)
- Anonymous browsing (T051)
- Tag filtering (T051)
- Pagination (T051)
- Trip detail viewing (T052)
- Responsive design

### Location Editing (location-editing.spec.ts)
- Click to add location on map (T053)
- Drag markers to adjust coordinates (T054)
- Reverse geocoding integration (T053)
- Edit location names (T054)
- Delete locations (T054)
- Multiple locations per trip

## Prerequisites

Before running E2E tests, ensure the following services are running:

### 1. Backend Server
```bash
# Terminal 1: Start backend
cd backend
poetry run uvicorn src.main:app --reload

# Or use the convenience script:
./run_backend.sh  # Linux/Mac
.\run_backend.ps1  # Windows PowerShell
```

**Backend must be running at**: `http://localhost:8000`

### 2. Frontend Server
```bash
# Terminal 2: Start frontend
cd frontend
npm run dev

# Or use the convenience script:
./run_frontend.sh  # Linux/Mac
.\run_frontend.ps1  # Windows PowerShell
```

**Frontend must be running at**: `http://localhost:5173`

## Running Tests

### Run All E2E Tests
```bash
cd frontend

# Run all tests (all browsers)
npx playwright test

# Run all tests with UI mode (interactive)
npx playwright test --ui
```

### Run Specific Test File
```bash
# Run only authentication tests
npx playwright test auth.spec.ts

# Run only trip creation tests
npx playwright test trip-creation.spec.ts

# Run only public feed tests
npx playwright test public-feed.spec.ts

# Run only location editing tests
npx playwright test location-editing.spec.ts
```

### Run Specific Browser
```bash
# Run on Chromium only
npx playwright test --project=chromium

# Run on Firefox only
npx playwright test --project=firefox

# Run on WebKit (Safari) only
npx playwright test --project=webkit
```

### Run in Debug Mode
```bash
# Debug a specific test
npx playwright test auth.spec.ts --debug

# Debug with Playwright Inspector
npx playwright test --debug

# Run in headed mode (see browser)
npx playwright test --headed
```

### Run Tests in Parallel
```bash
# Run with 4 workers (default is auto-detected)
npx playwright test --workers=4

# Run tests sequentially (useful for debugging)
npx playwright test --workers=1
```

## Test Reports

### HTML Report
After running tests, view the HTML report:

```bash
npx playwright show-report
```

The report includes:
- Test results summary
- Screenshots on failure
- Videos of failed tests
- Network logs
- Console output

### JSON Report
JSON results are saved to: `test-results/results.json`

## Environment Variables

Configure test environment with these variables:

```bash
# Frontend URL (default: http://localhost:5173)
export VITE_APP_URL=http://localhost:5173

# Backend API URL (default: http://localhost:8000)
export VITE_API_URL=http://localhost:8000

# Playwright base URL (for relative navigation)
export PLAYWRIGHT_BASE_URL=http://localhost:5173
```

## CI/CD Integration

Tests are configured to run in GitHub Actions with:

- Retries on failure (2 retries on CI)
- Parallel execution (2 workers on CI)
- HTML report artifacts
- Test result JSON for analysis

See: `.github/workflows/e2e-tests.yml`

## Troubleshooting

### Backend/Frontend Not Running
```
Error: Backend server is not running at http://localhost:8000
```

**Solution**: Start backend server first:
```bash
./run_backend.sh  # or .\run_backend.ps1
```

### Port Already in Use
```
Error: listen EADDRINUSE: address already in use :::5173
```

**Solution**: Kill process using the port:
```bash
# Linux/Mac
lsof -ti:5173 | xargs kill -9

# Windows
netstat -ano | findstr :5173
taskkill /PID <PID> /F
```

### Test Images Missing
```
Error: ENOENT: no such file or directory 'tests/fixtures/test-image.jpg'
```

**Solution**: Test images are auto-generated by global setup. If missing:
```bash
npx playwright test --global-setup
```

### Flaky Tests
If tests fail intermittently:

1. **Increase timeouts** (in playwright.config.ts):
   ```typescript
   timeout: 60 * 1000, // Increase to 60s
   ```

2. **Use `waitFor` assertions**:
   ```typescript
   await expect(page.locator('text=Success')).toBeVisible({ timeout: 10000 });
   ```

3. **Check network stability**: Slow network can cause timeouts

### Authentication Failures
If authentication tests fail consistently:

1. Check Turnstile configuration (should use dummy token in test)
2. Verify database is clean (no duplicate test users)
3. Check JWT secret key in backend `.env`

## Writing New Tests

### Test Structure
```typescript
import { test, expect } from '@playwright/test';

test.describe('Feature Name', () => {
  test.beforeEach(async ({ page }) => {
    // Setup: Navigate to page, login user, etc.
  });

  test('should do something', async ({ page }) => {
    // Arrange
    await page.goto('/some-page');

    // Act
    await page.click('button');

    // Assert
    await expect(page.locator('text=Success')).toBeVisible();
  });
});
```

### Best Practices

1. **Use data-testid attributes** for stable selectors:
   ```typescript
   await page.click('[data-testid="submit-button"]');
   ```

2. **Wait for navigation** before assertions:
   ```typescript
   await page.waitForURL('/success');
   await expect(page).toHaveURL('/success');
   ```

3. **Use meaningful assertions**:
   ```typescript
   // Good
   await expect(page.locator('h1')).toHaveText('Trip Created');

   // Avoid
   await page.waitForTimeout(5000); // Anti-pattern!
   ```

4. **Clean up test data**:
   ```typescript
   test.afterEach(async ({ page }) => {
     // Delete created resources via API
   });
   ```

## Performance

### Optimization Tips

1. **Reuse authentication state** (save login session):
   ```typescript
   // In global-setup.ts
   await context.storageState({ path: 'auth.json' });

   // In test
   test.use({ storageState: 'auth.json' });
   ```

2. **Parallelize independent tests**:
   ```typescript
   test.describe.configure({ mode: 'parallel' });
   ```

3. **Skip visual tests on CI** (if slow):
   ```typescript
   test.skip(!!process.env.CI, 'Skipping visual test on CI');
   ```

## References

- [Playwright Documentation](https://playwright.dev/)
- [Playwright Best Practices](https://playwright.dev/docs/best-practices)
- [Playwright API](https://playwright.dev/docs/api/class-playwright)
