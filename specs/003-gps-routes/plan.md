# Implementation Plan: GPS Routes Interactive

**Branch**: `003-gps-routes` | **Date**: 2026-01-21 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-gps-routes/spec.md`

**Note**: This plan was generated by `/speckit.plan` command. It includes research findings, data model, API contracts, and implementation guidelines.

## Summary

Implement GPS Routes Interactive feature to allow cyclists to upload GPX files to their trip entries, visualize routes on interactive maps with elevation profiles, and showcase their cycling adventures with precise geographical data.

**Technical Approach**:
- **Backend**: gpxpy library for GPX parsing, Douglas-Peucker algorithm for track simplification (90% storage reduction)
- **Frontend**: react-leaflet (existing) for maps, Recharts for elevation profiles
- **Processing**: FastAPI BackgroundTasks for async processing of large files (>1MB)
- **Storage**: Hybrid approach - simplified trackpoints in database (PostgreSQL/SQLite), original GPX files in filesystem

**Value Proposition**: 80% of trips expected to include GPX files (SC-006), enabling users to showcase exact routes and help others plan adventures.

---

## Technical Context

**Language/Version**: Python 3.12 (backend), TypeScript 5.x (frontend)
**Primary Dependencies**:
- Backend: gpxpy 1.6.2 (GPX parsing), rdp 0.8 (Douglas-Peucker simplification), FastAPI (existing), SQLAlchemy 2.0 (existing)
- Frontend: react-leaflet 4.x (existing - Feature 009), Recharts 2.10.0 (NEW - elevation charts)

**Storage**:
- Database: PostgreSQL (production), SQLite (development) - dual-database compatible
- Files: Original GPX files stored in `storage/gpx_files/{year}/{month}/{trip_id}/original.gpx`
- Trackpoints: Simplified points (Douglas-Peucker) in `track_points` table

**Testing**: pytest (backend unit/integration), Playwright (frontend E2E)

**Target Platform**: Linux server (backend), Web browsers (Chrome, Firefox, Safari, Edge)

**Project Type**: Web application (backend API + frontend SPA)

**Performance Goals** (from Success Criteria):
- SC-002: Parse <1MB GPX files in <3 seconds
- SC-003: Parse 5-10MB GPX files in <15 seconds
- SC-007: Load map with 1000 points in <3 seconds
- SC-014: Elevation chart interaction <100ms response
- SC-026: Achieve 30% storage optimization via track simplification

**Constraints**:
- File size limit: 10MB per GPX (FR-001)
- One GPX per trip maximum (FR-038)
- WGS84 coordinate system (A6)
- Elevation range validation: -420m (Dead Sea) to 8850m (Everest) - FR-034

**Scale/Scope**:
- Target: 80% of trips to include GPX files (SC-006)
- Typical GPX file: 1,000-10,000 trackpoints
- Simplified trackpoints: 500-1,000 points (80-90% reduction)
- Support up to 10,000 concurrent GPX uploads (future Celery migration)

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Code Quality & Maintainability ✅

- **PEP 8 Compliance**: All Python code follows PEP 8 (enforced by black + ruff)
- **Type Hints**: Full type annotations on all functions (GPXService, models)
- **Docstrings**: Google-style docstrings for all public APIs
- **Single Responsibility**: Each service/model/component has clear, single purpose
- **No Magic Numbers**: Constants in config.py (GPX_MAX_SIZE_MB=10, SIMPLIFICATION_EPSILON=0.0001)

**Verification**: Linting passes with zero warnings before commit.

### Testing Standards (Non-Negotiable) ✅

- **TDD Workflow**: Tests written FIRST for all features (see quickstart.md)
- **Unit Tests**: GPXService (parsing, simplification, validation) - target ≥90% coverage
- **Integration Tests**: GPX API endpoints (upload, status, track retrieval, download, delete)
- **Contract Tests**: OpenAPI schema validation (gpx-api.yaml)
- **Performance Tests**: Verify SC-002 (<3s), SC-003 (<15s), SC-007 (<3s), SC-014 (<100ms)

**Test Fixtures**: Sample GPX files in `tests/fixtures/gpx/` (short_route.gpx, camino_del_cid.gpx, no_elevation.gpx, invalid_gpx.xml)

### User Experience Consistency ✅

- **Spanish Primary**: All error messages in Spanish (see gpx-api.yaml examples)
- **Consistent API Response**:
  ```json
  {
    "success": true,
    "data": {...},
    "error": null
  }
  ```
- **HTTP Status Codes**: Correct usage (201 Created, 202 Accepted, 400 Bad Request, 404 Not Found)
- **Field-Specific Validation**: Clear error messages ("El archivo GPX no puede exceder 10MB")
- **Loading States**: Spinner during async processing, status polling every 2 seconds
- **Accessibility**: Alt text for map markers, ARIA labels for interactive elements

### Performance Requirements ✅

- **API Response Times**:
  - Simple queries (GPX metadata): <200ms p95
  - GPX processing <1MB: <3s (SC-002)
  - GPX processing 5-10MB: <15s (SC-003)
- **Database Optimization**:
  - Indexes on `gpx_files.trip_id`, `track_points.gpx_file_id + sequence`
  - Douglas-Peucker simplification reduces DB size by 80-90% (SC-026)
- **Map Rendering**: <3s load for 1000 trackpoints (SC-007)
- **Async Processing**: Files >1MB processed via FastAPI BackgroundTasks (non-blocking)

**Profiling**: Use pytest-benchmark for GPX parsing performance validation.

### Security & Data Protection ✅

- **File Upload Validation**:
  - MIME type check (application/gpx+xml)
  - File size limit (10MB)
  - XML structure validation via gpxpy
- **SQL Injection Prevention**: SQLAlchemy ORM only (no raw SQL)
- **XSS Prevention**: Sanitize GPX metadata before display
- **Authentication**: JWT required for upload/delete operations
- **Authorization**: Only trip owner can upload/delete GPX files
- **Cascade Deletion**: ON DELETE CASCADE ensures no orphaned GPS data (FR-036)

### Development Workflow ✅

- **Feature Branch**: `003-gps-routes` from `develop`
- **Conventional Commits**: `feat(gpx): add GPX upload endpoint (US1)`
- **PR Requirements**:
  - All tests passing (unit, integration, contract)
  - Coverage ≥90%
  - Linting zero warnings
  - Link to spec.md
  - Screenshots of map visualization
- **Code Review Checklist**:
  - Verify Douglas-Peucker simplification accuracy
  - Check async processing works for large files
  - Validate Spanish error messages
  - Confirm performance targets met

---

## Project Structure

### Documentation (this feature)

```text
specs/003-gps-routes/
├── spec.md              # Feature specification with 5 User Stories
├── plan.md              # This file (/speckit.plan output)
├── research.md          # Technical decisions (gpxpy, RDP, Recharts, etc.)
├── data-model.md        # Database schema (gpx_files, track_points tables)
├── quickstart.md        # 30-minute implementation guide
├── contracts/
│   └── gpx-api.yaml     # OpenAPI 3.0 specification for GPX endpoints
└── tasks.md             # NOT YET CREATED (use /speckit.tasks command)
```

### Source Code (repository root)

```text
# Web application structure (backend + frontend)
backend/
├── src/
│   ├── models/
│   │   └── gpx.py                    # NEW: GPXFile, TrackPoint models
│   ├── schemas/
│   │   └── gpx.py                    # NEW: Pydantic schemas (GPXUploadResponse, TrackDataResponse)
│   ├── services/
│   │   └── gpx_service.py            # NEW: GPX parsing, simplification, validation
│   ├── api/
│   │   └── trips.py                  # MODIFY: Add GPX endpoints (POST, GET, DELETE /trips/{trip_id}/gpx)
│   ├── utils/
│   │   └── gpx_simplifier.py         # NEW: Douglas-Peucker algorithm implementation
│   └── config.py                     # MODIFY: Add GPX_MAX_SIZE_MB, SIMPLIFICATION_EPSILON constants
├── migrations/versions/
│   └── xxx_create_gpx_tables.py      # NEW: Alembic migration for gpx_files, track_points
└── tests/
    ├── unit/
    │   └── test_gpx_service.py       # NEW: Test parsing, simplification, validation
    ├── integration/
    │   └── test_gpx_api.py           # NEW: Test upload, status, track, download, delete endpoints
    ├── performance/
    │   └── test_gpx_parsing.py       # NEW: Verify SC-002, SC-003 performance targets
    └── fixtures/gpx/
        ├── short_route.gpx           # 50KB, 200 points - unit tests
        ├── camino_del_cid.gpx        # 500KB, 2000 points - integration tests
        ├── long_route_5mb.gpx        # 5MB, 15000 points - performance tests
        ├── no_elevation.gpx          # Missing elevation handling
        ├── invalid_gpx.xml           # Error handling test
        └── oversized.gpx             # 12MB - size validation test

frontend/
├── src/
│   ├── components/trips/
│   │   ├── TripMap.tsx               # MODIFY: Add Polyline for GPX routes, start/end markers
│   │   ├── GPXUploader.tsx           # NEW: Drag-drop file upload with status polling
│   │   ├── GPXStats.tsx              # NEW: Distance, elevation gain/loss, max/min altitude cards
│   │   └── ElevationProfile.tsx      # NEW: Recharts area chart with click-to-zoom
│   ├── hooks/
│   │   ├── useGPXUpload.ts           # NEW: Upload hook with polling for async processing
│   │   └── useGPXTrack.ts            # NEW: Fetch trackpoints hook
│   ├── services/
│   │   └── gpxService.ts             # NEW: API client (uploadGPX, getStatus, getTrack, downloadGPX, deleteGPX)
│   ├── types/
│   │   └── gpx.ts                    # NEW: TypeScript interfaces (GPXTrack, TrackPoint, GPXUploadResponse)
│   └── pages/
│       └── TripDetailPage.tsx        # MODIFY: Add GPX section with uploader/map/stats/profile
└── tests/
    ├── unit/
    │   └── GPXUploader.test.tsx      # NEW: Test drag-drop, validation, loading states
    └── e2e/
        └── gpx-upload.spec.ts        # NEW: Playwright E2E test for full upload workflow
```

**Structure Decision**: Web application architecture (Option 2 from template). Backend serves GPX API endpoints, frontend consumes via REST. Existing TripMap component extended for GPX Polyline rendering. New Recharts dependency for elevation profiles.

---

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No violations** - All constitutional requirements satisfied:
- Code quality standards met (PEP 8, type hints, docstrings)
- TDD workflow enforced (tests written first, ≥90% coverage)
- User experience consistent (Spanish errors, standard API responses)
- Performance targets defined and testable (SC-002, SC-003, SC-007, SC-014)
- Security validated (file validation, SQL injection prevention, authentication)

**Optional Complexity (Justified)**:
- **Douglas-Peucker Simplification**: Adds preprocessing overhead (~1-2s) but reduces storage by 80-90% and ensures <3s map load (SC-007, SC-026). Alternative (storing all points) would violate performance targets.
- **FastAPI BackgroundTasks**: Adds async complexity but necessary for <15s processing of 5-10MB files (SC-003) without blocking user. Alternative (synchronous processing) would timeout.

---

## Implementation Phases

### Phase 0: Research & Decisions (COMPLETED ✅)

**Output**: `research.md` with all technical decisions

**Decisions Made**:
1. **GPX Parsing**: gpxpy 1.6.2 (vs xml.etree, lxml, fastgpx)
2. **Async Processing**: FastAPI BackgroundTasks for MVP (plan Celery migration for v2)
3. **Track Storage**: Simplified points in DB + original file preserved
4. **Simplification**: Ramer-Douglas-Peucker (epsilon=0.0001°)
5. **Map Library**: react-leaflet 4.x (already integrated)
6. **Elevation Chart**: Recharts 2.10.0 (fallback to Chart.js if performance issues)

**Rationale**: See `research.md` for detailed justifications and alternatives considered.

---

### Phase 1: Design & Contracts (COMPLETED ✅)

**Outputs**: `data-model.md`, `contracts/gpx-api.yaml`, `quickstart.md`

#### Data Model

**New Tables**:
- `gpx_files`: GPX metadata and processing results (1:1 with Trip)
- `track_points`: Simplified GPS trackpoints (N:1 with GPXFile)

**Key Relationships**:
- Trip → GPXFile (1:1, CASCADE DELETE)
- GPXFile → TrackPoint (1:N, CASCADE DELETE)

**Simplification Strategy**:
- Original: 10,000 points
- Simplified: ~500-1,000 points (80-90% reduction)
- Algorithm: Douglas-Peucker with epsilon=0.0001° (~10m precision)

#### API Contracts

**Endpoints Defined** (see `contracts/gpx-api.yaml`):
- `POST /trips/{trip_id}/gpx`: Upload GPX file (US1 - FR-001)
- `GET /trips/{trip_id}/gpx`: Get GPX metadata
- `DELETE /trips/{trip_id}/gpx`: Delete GPX file (FR-036)
- `GET /gpx/{gpx_file_id}/status`: Poll processing status
- `GET /gpx/{gpx_file_id}/track`: Get simplified trackpoints (US2 - FR-009)
- `GET /gpx/{gpx_file_id}/download`: Download original GPX (FR-039)

**Response Format**:
```json
{
  "success": true,
  "data": {
    "gpx_file_id": "uuid",
    "processing_status": "completed",
    "distance_km": 45.3,
    "elevation_gain": 1200.5,
    ...
  }
}
```

#### Agent Context Update

**Technologies Added to CLAUDE.md**:
- Python 3.12 (backend - existing)
- TypeScript 5.x (frontend - existing)
- gpxpy 1.6.2 (NEW - GPX parsing)
- rdp 0.8 (NEW - Douglas-Peucker algorithm)
- Recharts 2.10.0 (NEW - elevation charts)
- react-leaflet 4.x (existing - Feature 009)

**Update Completed**: PowerShell script executed successfully.

---

### Phase 2: Implementation (NEXT STEP - Use `/speckit.tasks`)

**Not Yet Started** - Use `/speckit.tasks` command to generate `tasks.md` with step-by-step implementation tasks.

**Recommended Task Breakdown**:
1. Backend Models & Migrations (2 hours)
2. GPX Service Implementation (3 hours)
3. API Endpoints (2 hours)
4. Unit Tests (2 hours)
5. Frontend Components (3 hours)
6. Integration Tests (2 hours)
7. E2E Tests (1 hour)
8. Performance Validation (1 hour)

**Total Estimate**: ~16 hours (2 days)

---

## Performance Validation Plan

### Success Criteria Verification

| Criterion | Target | Test Method | Pass Condition |
|-----------|--------|-------------|----------------|
| SC-002 | <3s for <1MB files | pytest-benchmark on 500KB GPX | avg < 3.0s |
| SC-003 | <15s for 5-10MB files | pytest-benchmark on 7MB GPX | avg < 15.0s |
| SC-007 | <3s map load (1000 points) | Playwright performance test | loadEventEnd - navigationStart < 3000ms |
| SC-014 | <100ms chart interaction | React Performance Profiler | hover event → render < 100ms |
| SC-026 | 30% storage optimization | Compare original vs simplified | reduction ≥ 30% |

### Performance Testing Scripts

```bash
# Backend: GPX parsing performance
pytest tests/performance/test_gpx_parsing.py -v --benchmark-only

# Frontend: Map rendering performance
npm run test:performance -- tests/performance/map-render.test.tsx

# Full integration: Upload → Process → Render
pytest tests/integration/test_gpx_workflow.py::test_complete_gpx_workflow_performance -v
```

---

## Risk Mitigation

| Risk | Impact | Mitigation | Status |
|------|--------|------------|--------|
| **GPX files with corrupt data** | Medium | Extensive validation via gpxpy, clear Spanish error messages | ✅ Planned |
| **Performance issues with large files** | High | Douglas-Peucker simplification (90% reduction), async processing | ✅ Implemented |
| **Elevation data noise** | Low | 3-meter threshold filter, anomaly detection (-420m to 8850m) | ✅ Planned |
| **Storage growth** | Medium | 10MB file limit, track simplification, future S3 migration path | ✅ Planned |
| **Browser compatibility** | Low | react-leaflet works in all modern browsers (Chrome, Firefox, Safari, Edge) | ✅ Verified |

---

## Dependencies

### Backend (add to `pyproject.toml`):
```toml
[tool.poetry.dependencies]
gpxpy = "^1.6.2"        # GPX parsing and calculations
rdp = "^0.8"            # Douglas-Peucker simplification
```

### Frontend (add to `package.json`):
```json
{
  "dependencies": {
    "recharts": "^2.10.0"   // Elevation profile charts
  }
}
```

**Note**: react-leaflet already installed in Feature 009 (GPS Coordinates).

---

## Acceptance Criteria Summary

**Phase 1 (MVP) - Complete When**:
- ✅ User can upload GPX file (<10MB) to trip
- ✅ System processes GPX and extracts distance, elevation, trackpoints
- ✅ Map displays route as Polyline with start (green) and end (red) markers
- ✅ Elevation profile shows chart with hover tooltips
- ✅ Trackpoints simplified to ~500-1,000 points (80-90% reduction)
- ✅ All performance targets met (SC-002, SC-003, SC-007, SC-014)
- ✅ Unit tests ≥90% coverage
- ✅ Integration tests passing
- ✅ Spanish error messages for all validation failures

**Success Metrics** (SC-029 - SC-032):
- 90% of users upload GPX successfully without help
- 85% of users find map/elevation profile useful
- <10% abandonment rate during upload
- 85% comprehension of error messages

---

## Next Actions

1. **Generate Implementation Tasks**: Run `/speckit.tasks` to create `tasks.md`
2. **Create Feature Branch**: `git checkout -b 003-gps-routes`
3. **Install Dependencies**: `poetry add gpxpy rdp && npm install recharts`
4. **Apply Migrations**: `alembic upgrade head`
5. **Start Implementation**: Follow tasks.md step-by-step
6. **Run Tests**: Continuous TDD workflow (test first, then implement)
7. **Performance Validation**: Verify all SC-* criteria before PR
8. **Create PR**: Link to spec.md, include screenshots of map/chart

---

## References

- **Specification**: [specs/003-gps-routes/spec.md](./spec.md)
- **Research Findings**: [research.md](./research.md)
- **Data Model**: [data-model.md](./data-model.md)
- **API Contracts**: [contracts/gpx-api.yaml](./contracts/gpx-api.yaml)
- **Quickstart Guide**: [quickstart.md](./quickstart.md)
- **Constitution**: [.specify/memory/constitution.md](../../.specify/memory/constitution.md)

---

**Plan Status**: ✅ **COMPLETE** - Ready for implementation. Use `/speckit.tasks` to generate detailed task breakdown.

**Estimated Implementation Time**: 16 hours (2 days)
**Risk Level**: Low (all technical decisions validated, no constitution violations)
**Dependencies**: All resolvable (gpxpy, rdp, recharts available in stable versions)
