# [ARCHIVED - v0.2.0] ContraVento - Complete Deployment Guide

**Archived on**: 2026-01-13
**Reason**: Updated to include frontend deployment instructions and cross-references to QUICK_START.md
**Replaced by**: [DEPLOYMENT.md](../DEPLOYMENT.md)

---

[Original content below...]

---

# ContraVento - Complete Deployment Guide

> **Notice**: This guide consolidates DEPLOYMENT.md and DOCKER_DEPLOYMENT.md (archived 2026-01-08)
> For quick start scenarios, see [QUICK_START.md](../../QUICK_START.md)

**Last Updated**: 2026-01-08

---

## Table of Contents

1. [Introduction & Prerequisites](#1-introduction--prerequisites)
2. [Quick Decision Tree](#2-quick-decision-tree)
3. [Local Development Environments](#3-local-development-environments)
4. [Docker-Based Deployments](#4-docker-based-deployments)
5. [Traditional & Cloud Deployments](#5-traditional--cloud-deployments)
6. [Database Management](#6-database-management)
7. [Reverse Proxy & SSL](#7-reverse-proxy--ssl)
8. [Monitoring & Logging](#8-monitoring--logging)
9. [Security](#9-security)
10. [Scaling & Performance](#10-scaling--performance)
11. [CI/CD Integration](#11-cicd-integration)
12. [Troubleshooting](#12-troubleshooting)
13. [Reference](#13-reference)

---

## 1. Introduction & Prerequisites

ContraVento is a FastAPI-based cycling social platform designed to run across multiple environments, from local SQLite development to high-availability production clusters.

### 1.1 Software Requirements

**Essential:**
- **Docker 24.0+** and **Docker Compose 2.0+** (for Docker-based deployments)
- **Python 3.11+** (for local development)
- **Git** (for version control)

**Database Options:**
- **SQLite 3** (local development, zero configuration)
- **PostgreSQL 14+** (staging, production, and PostgreSQL-specific testing)

**Optional but Recommended:**
- **Poetry 1.7+** (Python dependency management)
- **psql** (PostgreSQL client for database administration)
- **Redis 7+** (caching, sessions - required for production)

### 1.2 External Services

**Production Requirements:**
- **SMTP Provider**: SendGrid, AWS SES, Mailgun, or Gmail for transactional emails
- **Domain Name**: With DNS properly configured
- **SSL Certificate**: Let's Encrypt (recommended) or commercial certificate
- **Monitoring** (recommended): Sentry, DataDog, CloudWatch, or Prometheus/Grafana

### 1.3 Deployment Philosophy

ContraVento follows a **progressive complexity** approach:

```
SQLite Local (No Docker)  â†’  Docker Local  â†’  Docker Dev  â†’  Staging  â†’  Production
     Instant                   ~10-30s          ~20s          ~40s       ~60s
     Zero config              Minimal          Moderate      Complete   Full stack
```

**Core Principles:**
1. **Development Speed First**: Start with SQLite, scale up as needed
2. **Environment Parity**: Staging mirrors production exactly
3. **Docker Compose Primary**: Traditional deployments are alternatives
4. **Security by Default**: Production-grade security from staging onwards

---

## 2. Quick Decision Tree

### 2.1 Choose Your Development Environment

```
â”Œâ”€ Do you need Docker? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  NO â”€â”€â–º SQLite Local (Fastest, zero config)             â”‚
â”‚         ./run-local-dev.sh                               â”‚
â”‚         Perfect for: Daily development                   â”‚
â”‚                                                          â”‚
â”‚  YES â”€â”€â–º Continue below...                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ What are you working on? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  Basic features (trips, profiles, stats)                 â”‚
â”‚  â”€â”€â–º Docker Local Minimal                                â”‚
â”‚      ./deploy.sh local-minimal                           â”‚
â”‚      PostgreSQL + Backend only                           â”‚
â”‚                                                          â”‚
â”‚  Email/Auth features                                     â”‚
â”‚  â”€â”€â–º Docker Local Full                                   â”‚
â”‚      ./deploy.sh local                                   â”‚
â”‚      + MailHog + pgAdmin + Redis                         â”‚
â”‚                                                          â”‚
â”‚  Integration testing                                     â”‚
â”‚  â”€â”€â–º Docker Dev                                          â”‚
â”‚      ./deploy.sh dev                                     â”‚
â”‚      + Nginx + Real SMTP                                 â”‚
â”‚                                                          â”‚
â”‚  Pre-production testing                                  â”‚
â”‚  â”€â”€â–º Docker Staging                                      â”‚
â”‚      ./deploy.sh staging                                 â”‚
â”‚      + SSL + Monitoring                                  â”‚
â”‚                                                          â”‚
â”‚  Live production                                         â”‚
â”‚  â”€â”€â–º Docker Production                                   â”‚
â”‚      ./deploy.sh prod                                    â”‚
â”‚      + HA + Auto-scaling                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Quick Command Reference

| Scenario | Environment | Command | Startup Time |
|----------|-------------|---------|--------------|
| "I want to start NOW" | SQLite Local | `./run-local-dev.sh` | Instant |
| "I need PostgreSQL" | Docker Minimal | `./deploy.sh local-minimal` | ~10s |
| "Testing emails" | Docker Full | `./deploy.sh local` | ~30s |
| "Integration tests" | Docker Dev | `./deploy.sh dev` | ~20s |
| "Final QA testing" | Docker Staging | `./deploy.sh staging` | ~40s |
| "Serve real users" | Docker Production | `./deploy.sh prod` | ~60s |

---

## 3. Local Development Environments

### 3.1 SQLite Local (No Docker) - FASTEST âš¡

**Perfect for**: Daily development, quick prototyping, learning the codebase.

#### 3.1.1 Quick Start

**Linux/Mac:**
```bash
# First-time setup
cd contravento-application-python
./run-local-dev.sh --setup

# Start development server
./run-local-dev.sh

# Access:
# - Backend API: http://localhost:8000
# - API Docs: http://localhost:8000/docs
```

**Windows:**
```powershell
# First-time setup
cd contravento-application-python
.\run-local-dev.ps1 -Setup

# Start development server
.\run-local-dev.ps1

# Access:
# - Backend API: http://localhost:8000
# - API Docs: http://localhost:8000/docs
```

#### 3.1.2 What Setup Does Automatically

1. âœ… Copies `.env` from `backend/.env.dev.example`
2. âœ… Installs dependencies with Poetry
3. âœ… Generates `SECRET_KEY` automatically
4. âœ… Runs Alembic migrations
5. âœ… Creates test users (`testuser`, `maria_garcia`)
6. âœ… Loads 9 predefined achievements

#### 3.1.3 Test Users

| Username | Email | Password |
|----------|-------|----------|
| testuser | test@example.com | TestPass123! |
| maria_garcia | maria@example.com | SecurePass456! |

#### 3.1.4 Database Location

SQLite database stored at: `backend/contravento_dev.db`

#### 3.1.5 Advantages & Limitations

**Advantages:**
- âš¡ Instant startup (no Docker overhead)
- ğŸ¯ Zero configuration required
- ğŸ’» Works on any OS with Python 3.11+
- ğŸ”§ Perfect for daily development
- ğŸ“¦ Minimal disk space (~50 MB)

**Limitations:**
- ğŸ“Š SQLite only (not PostgreSQL)
- ğŸ“§ No email testing UI (emails logged to console)
- ğŸ’¾ No Redis (not needed for basic features)
- ğŸ–¥ï¸ No pgAdmin (use VS Code extensions or sqlite3 CLI)

#### 3.1.6 Useful Commands

```bash
# Reset database (deletes all data)
./run-local-dev.sh --reset           # Linux/Mac
.\run-local-dev.ps1 -Reset           # Windows

# View help
./run-local-dev.sh --help
.\run-local-dev.ps1 -Help

# View SQLite database
sqlite3 backend/contravento_dev.db
.tables
SELECT * FROM users;
.quit

# Run tests against SQLite
cd backend
poetry run pytest
```

---

### 3.2 Docker Local Minimal (PostgreSQL + Backend)

**Perfect for**: Testing PostgreSQL compatibility, migration validation, minimal resource usage.

#### 3.2.1 Services Included

- âœ… **PostgreSQL 16** (database)
- âœ… **Backend FastAPI** (with hot reload)
- âŒ Redis, MailHog, pgAdmin (not included)

#### 3.2.2 Quick Start

```bash
# 1. Copy environment file
cp .env.local-minimal.example .env.local-minimal

# 2. Generate SECRET_KEY
python -c "import secrets; print(secrets.token_urlsafe(64))"

# 3. Edit .env.local-minimal and set:
#    - SECRET_KEY (from step 2)
#    - POSTGRES_PASSWORD (any secure password)

# 4. Start environment
./deploy.sh local-minimal        # Linux/Mac
.\deploy.ps1 local-minimal       # Windows

# 5. Access
# - Backend API: http://localhost:8000
# - API Docs: http://localhost:8000/docs
# - PostgreSQL: localhost:5432
```

#### 3.2.3 Configuration Highlights

```bash
# .env.local-minimal
APP_NAME=ContraVento-LocalMinimal
APP_ENV=local
DEBUG=true
DATABASE_URL=postgresql+asyncpg://contravento:password@postgres:5432/contravento
BCRYPT_ROUNDS=4  # Fast for development
LOG_LEVEL=DEBUG
SMTP_HOST=localhost  # Emails logged to console
```

#### 3.2.4 Database Access

```bash
# Connect to PostgreSQL with psql
docker exec -it contravento-db-local-minimal psql -U contravento -d contravento

# Common psql commands
\dt          # List tables
\d users     # Describe table
\du          # List users
\l           # List databases
\q           # Quit

# Run SQL directly
docker exec -it contravento-db-local-minimal psql -U contravento -d contravento -c "SELECT COUNT(*) FROM users;"
```

#### 3.2.5 When to Use

- âœ… Testing PostgreSQL-specific features (ARRAY types, native UUID)
- âœ… Validating migrations before staging
- âœ… Pre-staging PostgreSQL compatibility checks
- âœ… Debugging PostgreSQL-specific issues
- âœ… Want PostgreSQL but minimal resource usage (~500 MB RAM)

---

### 3.3 Docker Local Full (Complete Stack)

**Perfect for**: Email testing, Redis cache development, visual database tools, complete integration testing.

#### 3.3.1 Services Included

- âœ… **PostgreSQL 16** (database)
- âœ… **Redis 7** (cache/sessions)
- âœ… **Backend FastAPI** (with hot reload)
- âœ… **MailHog** (email testing UI)
- âœ… **pgAdmin 4** (database management UI)

#### 3.3.2 Quick Start

```bash
# 1. Copy environment file
cp .env.local.example .env.local

# 2. Generate SECRET_KEY
python -c "import secrets; print(secrets.token_urlsafe(64))"

# 3. Edit .env.local and set:
#    - SECRET_KEY (from step 2)
#    - POSTGRES_PASSWORD
#    - REDIS_PASSWORD
#    - PGADMIN_PASSWORD

# 4. Start environment
./deploy.sh local                # Linux/Mac
.\deploy.ps1 local               # Windows

# 5. Access
# - Backend API: http://localhost:8000
# - API Docs: http://localhost:8000/docs
# - MailHog UI: http://localhost:8025
# - pgAdmin: http://localhost:5050
# - PostgreSQL: localhost:5432
# - Redis: localhost:6379
```

#### 3.3.3 Service Access Details

| Service | URL | Credentials |
|---------|-----|-------------|
| Backend API | http://localhost:8000 | - |
| API Docs (Swagger) | http://localhost:8000/docs | - |
| MailHog Web UI | http://localhost:8025 | - |
| pgAdmin | http://localhost:5050 | See `.env.local` |
| PostgreSQL | localhost:5432 | See `.env.local` |
| Redis | localhost:6379 | See `.env.local` |

#### 3.3.4 Configuration Highlights

```bash
# .env.local
APP_NAME=ContraVento-Local
APP_ENV=local
DEBUG=true
DATABASE_URL=postgresql+asyncpg://contravento:password@postgres:5432/contravento
REDIS_URL=redis://:password@redis:6379/0
BCRYPT_ROUNDS=4  # Fast for development
LOG_LEVEL=DEBUG
SMTP_HOST=mailhog
SMTP_PORT=1025
SMTP_TLS=false
```

#### 3.3.5 MailHog Usage

**Purpose**: Test email sending without a real SMTP server.

```bash
# All emails sent from backend appear in MailHog UI
# Access: http://localhost:8025

# Example: Test registration email
curl -X POST http://localhost:8000/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testmail",
    "email": "testmail@example.com",
    "password": "TestPass123!",
    "full_name": "Test Mail"
  }'

# Check MailHog UI - you'll see the verification email
```

#### 3.3.6 pgAdmin Setup

See [QUICK_START.md - pgAdmin Setup Guide](../../QUICK_START.md#pgadmin-setup) for detailed instructions.

**Quick Setup:**
1. Open http://localhost:5050
2. Login with credentials from `.env.local` (`PGADMIN_DEFAULT_EMAIL` / `PGADMIN_DEFAULT_PASSWORD`)
3. Add server:
   - Name: `Local ContraVento`
   - Host: `postgres` (Docker network)
   - Port: `5432`
   - Username: `contravento` (from `POSTGRES_USER`)
   - Password: (from `POSTGRES_PASSWORD`)

#### 3.3.7 When to Use

- âœ… Developing authentication/email features
- âœ… Testing password reset emails
- âœ… Implementing Redis cache
- âœ… Prefer visual database tools (pgAdmin)
- âœ… Full local integration testing
- âœ… Demonstrating features to stakeholders

#### 3.3.8 Resource Requirements

- **RAM**: ~1 GB
- **Disk**: ~2 GB
- **Startup time**: ~30 seconds

---

### 3.4 Environment Comparison

| Feature | SQLite Local | Docker Minimal | Docker Full |
|---------|:------------:|:--------------:|:-----------:|
| **Startup Time** | Instant | ~10s | ~30s |
| **RAM Usage** | ~100 MB | ~500 MB | ~1 GB |
| **Docker Required** | âŒ | âœ… | âœ… |
| **Database** | SQLite | PostgreSQL | PostgreSQL |
| **Redis** | âŒ | âŒ | âœ… |
| **Email Testing UI** | âŒ | âŒ | âœ… (MailHog) |
| **Database UI** | âŒ | âŒ | âœ… (pgAdmin) |
| **Hot Reload** | âœ… | âœ… | âœ… |
| **Debug Mode** | âœ… | âœ… | âœ… |
| **Test Data** | âœ… Auto | âœ… Auto | âœ… Auto |
| **Best For** | Daily dev | PostgreSQL testing | Email/cache features |

---

## 4. Docker-Based Deployments

### 4.1 Docker Compose Architecture

ContraVento uses a **multi-file Docker Compose approach**:

- **Base file** (`docker-compose.yml`): Common service definitions
- **Overlay files** (`docker-compose.<env>.yml`): Environment-specific configurations
- **Environment files** (`.env.<env>`): Environment variables

**Benefits:**
- âœ… Single source of truth (DRY principle)
- âœ… Environment-specific overrides without duplication
- âœ… Easy to maintain and extend
- âœ… Clear separation of concerns

**Service Stack Overview:**

| Service | Local Minimal | Local Full | Dev | Staging | Prod |
|---------|:-------------:|:----------:|:---:|:-------:|:----:|
| **postgres** | âœ… | âœ… | âœ… | âœ… | âœ… |
| **backend** | âœ… | âœ… | âœ… | âœ… | âœ… (3 replicas) |
| **redis** | âŒ | âœ… | âœ… | âœ… | âœ… |
| **mailhog** | âŒ | âœ… | âŒ | âŒ | âŒ |
| **pgadmin** | âŒ | âœ… | âŒ | âŒ | âŒ |
| **nginx** | âŒ | âŒ | âœ… | âœ… | âœ… |
| **certbot** | âŒ | âŒ | âŒ | âŒ | âœ… |
| **prometheus** | âŒ | âŒ | âŒ | âœ… | âœ… |
| **grafana** | âŒ | âŒ | âŒ | âœ… | âœ… |
| **exporters** | âŒ | âŒ | âŒ | âŒ | âœ… |

---

### 4.2 Dev Environment (Integration Testing)

**Purpose**: Integration testing with production-like build (no hot reload).

#### 4.2.1 Characteristics

- âœ… Production build (Docker image rebuilt, no volume mounts)
- âœ… Nginx reverse proxy
- âœ… Real SMTP server (Mailtrap, Mailgun, etc.)
- âœ… Structured logging (JSON format)
- âŒ No debug mode
- âŒ No MailHog (use real SMTP)
- âŒ No pgAdmin

#### 4.2.2 Quick Start

```bash
# 1. Copy environment file
cp .env.dev.example .env.dev

# 2. Generate SECRET_KEY (min 64 chars)
python -c "import secrets; print(secrets.token_urlsafe(64))"

# 3. Edit .env.dev and set:
#    - SECRET_KEY (from step 2)
#    - POSTGRES_PASSWORD
#    - REDIS_PASSWORD
#    - SMTP_HOST, SMTP_USER, SMTP_PASSWORD (e.g., Mailtrap)

# 4. Start environment
./deploy.sh dev                  # Linux/Mac
.\deploy.ps1 dev                 # Windows

# 5. Access
# - Backend API: http://dev.contravento.local:8000
# - API Docs: http://dev.contravento.local:8000/docs
```

#### 4.2.3 Configuration Highlights

```bash
# .env.dev
APP_NAME=ContraVento-Dev
APP_ENV=development
DEBUG=false                    # Production-like behavior
BCRYPT_ROUNDS=10               # Moderate security
LOG_FORMAT=json                # Structured logging
LOG_LEVEL=INFO

# Real SMTP (example: Mailtrap)
SMTP_HOST=smtp.mailtrap.io
SMTP_PORT=587
SMTP_USER=your_mailtrap_user
SMTP_PASSWORD=your_mailtrap_password
SMTP_TLS=true
```

#### 4.2.4 Nginx Configuration

The dev environment includes Nginx as a reverse proxy:

```nginx
# Nginx proxies requests to backend container
upstream backend {
    server backend:8000;
}

server {
    listen 80;
    server_name dev.contravento.local;

    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 4.2.5 When to Use

- âœ… Testing integrations before staging
- âœ… CI/CD pipeline validation
- âœ… Team collaboration environment
- âœ… Validate production build works
- âœ… Test with real SMTP without production credentials

#### 4.2.6 Testing in Dev

```bash
# View logs
./deploy.sh dev logs

# Run integration tests
docker-compose -f docker-compose.yml -f docker-compose.dev.yml \
  --env-file .env.dev exec backend poetry run pytest tests/integration/

# Check Nginx status
docker-compose -f docker-compose.yml -f docker-compose.dev.yml \
  --env-file .env.dev exec nginx nginx -t
```

---

### 4.3 Staging Environment

**Purpose**: Production mirror for final testing, QA, and UAT.

#### 4.3.1 Characteristics

- âœ… Identical to production configuration
- âœ… Monitoring (Prometheus + Grafana)
- âœ… SSL/TLS certificates
- âœ… Resource limits and health checks
- âœ… Automated backups
- âœ… Full security (bcrypt rounds = 12)
- âœ… Separate database from production

#### 4.3.2 Quick Start

```bash
# 1. Copy environment file
cp .env.staging.example .env.staging

# 2. Generate STRONG SECRET_KEY (min 96 chars)
python -c "import secrets; print(secrets.token_urlsafe(96))"

# 3. Generate strong passwords
openssl rand -base64 32  # Database password
openssl rand -base64 32  # Redis password

# 4. Edit .env.staging and set:
#    - SECRET_KEY (min 96 chars)
#    - POSTGRES_PASSWORD (min 32 chars)
#    - REDIS_PASSWORD
#    - SMTP_* (production SMTP or Mailtrap)
#    - DOMAIN (staging.contravento.com)
#    - GRAFANA_ADMIN_PASSWORD

# 5. Configure DNS
# Point staging.contravento.com to server IP

# 6. Start environment
./deploy.sh staging              # Linux/Mac
.\deploy.ps1 staging             # Windows

# 7. Verify SSL
curl -I https://staging.contravento.com
```

#### 4.3.3 Configuration Highlights

```bash
# .env.staging
APP_NAME=ContraVento-Staging
APP_ENV=production               # Production mode!
DEBUG=false
BCRYPT_ROUNDS=12                 # Production-level security

# Database (separate from production)
DATABASE_URL=postgresql+asyncpg://contravento_staging:STRONG_PASSWORD@postgres:5432/contravento_staging
POSTGRES_DB=contravento_staging
POSTGRES_USER=contravento_staging

# Redis (different DB index)
REDIS_URL=redis://:STRONG_PASSWORD@redis:6379/1

# CORS (staging domain only)
CORS_ORIGINS=https://staging.contravento.com

# Monitoring
SENTRY_DSN=https://your-staging-sentry-dsn@sentry.io/staging-project
SENTRY_ENVIRONMENT=staging
```

#### 4.3.4 Access Points

| Service | URL | Purpose |
|---------|-----|---------|
| Backend API | https://staging.contravento.com | Public API |
| Grafana | http://server-ip:3000 | Metrics dashboards |
| Prometheus | http://server-ip:9090 | Metrics collection |

#### 4.3.5 Monitoring Setup

Staging includes Prometheus and Grafana for monitoring:

```bash
# Access Grafana
# URL: http://localhost:3000 (or server IP)
# Default credentials: See GRAFANA_ADMIN_USER/PASSWORD in .env.staging

# Import ContraVento dashboards
# Dashboards available in: monitoring/grafana/dashboards/

# Key metrics:
# - API response times
# - Request rate
# - Error rate
# - Database connections
# - Redis hit/miss ratio
```

#### 4.3.6 Testing Checklist

```bash
# [ ] Health check responds
curl https://staging.contravento.com/health
# Expected: {"status": "healthy"}

# [ ] API responds
curl https://staging.contravento.com/
# Expected: {"message": "Welcome to ContraVento API"}

# [ ] HTTPS works (SSL valid)
curl -I https://staging.contravento.com
# Expected: HTTP/2 200, valid certificate

# [ ] CORS configured correctly
curl -H "Origin: https://staging.contravento.com" \
     -I https://staging.contravento.com/health
# Expected: Access-Control-Allow-Origin header present

# [ ] Register user works
curl -X POST https://staging.contravento.com/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "test_staging",
    "email": "test@staging.com",
    "password": "TestPass123!",
    "full_name": "Test User"
  }'

# [ ] Email sent (check inbox or Mailtrap)
# [ ] Login works
# [ ] Upload files works
# [ ] Database connections stable
# [ ] Logs show no errors
# [ ] Performance within targets (Auth <500ms, Profile <200ms)
```

#### 4.3.7 When to Use

- âœ… Final testing before production release
- âœ… Client demos and user acceptance testing (UAT)
- âœ… Performance testing under production conditions
- âœ… Validate monitoring and alerting
- âœ… Train QA team on production environment

---

### 4.4 Production Environment (Docker)

**Purpose**: Live production environment serving real users with high availability.

#### 4.4.1 Characteristics

- âœ… Maximum security (bcrypt rounds = 14)
- âœ… High availability (3 backend replicas)
- âœ… Auto-scaling capabilities
- âœ… Automated SSL renewal (Certbot)
- âœ… Full monitoring stack (Prometheus + Grafana + exporters)
- âœ… Log aggregation
- âœ… Automated backups to external storage
- âœ… Rate limiting
- âœ… Production-grade database with connection pooling

#### 4.4.2 Quick Start

```bash
# 1. Copy environment file
cp .env.prod.example .env.prod

# 2. Generate VERY STRONG SECRET_KEY (min 128 chars)
python -c "import secrets; print(secrets.token_urlsafe(128))"

# 3. Generate strong passwords
openssl rand -base64 48  # Database password (min 48 chars)
openssl rand -base64 32  # Redis password (min 32 chars)

# 4. IMPORTANT: Use external secret manager (recommended)
#    - AWS Secrets Manager
#    - HashiCorp Vault
#    - Azure Key Vault
#    - Google Secret Manager

# 5. Edit .env.prod and set:
#    - SECRET_KEY (min 128 chars)
#    - POSTGRES_PASSWORD (min 48 chars)
#    - REDIS_PASSWORD (min 32 chars)
#    - SMTP_* (production SMTP credentials - SendGrid, SES, etc.)
#    - DOMAIN (api.contravento.com)
#    - All monitoring/alerting credentials
#    - SENTRY_DSN (production project)

# 6. Configure DNS
# Point api.contravento.com to production server IP

# 7. Start environment
./deploy.sh prod                 # Linux/Mac
.\deploy.ps1 prod                # Windows

# 8. Verify SSL certificates
curl -I https://api.contravento.com

# 9. Run post-deployment checks (see section 4.4.6)
```

#### 4.4.3 Configuration Highlights

```bash
# .env.prod
APP_NAME=ContraVento
APP_ENV=production
DEBUG=false                      # CRITICAL: Must be false!
BCRYPT_ROUNDS=14                 # Maximum security

# Database (production)
DATABASE_URL=postgresql+asyncpg://contravento_user:VERY_STRONG_PASSWORD@postgres:5432/contravento
POSTGRES_DB=contravento
POSTGRES_USER=contravento_user

# Redis (production, DB index 0)
REDIS_URL=redis://:VERY_STRONG_PASSWORD@redis:6379/0

# SMTP (production - example: SendGrid)
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASSWORD=YOUR_SENDGRID_API_KEY
SMTP_FROM=noreply@contravento.com
SMTP_TLS=true                    # CRITICAL: Must be true!

# CORS (ONLY production domains)
CORS_ORIGINS=https://contravento.com,https://www.contravento.com

# Logging (minimal in production)
LOG_LEVEL=WARNING                # Only warnings/errors
LOG_FORMAT=json

# Monitoring
SENTRY_DSN=https://your-production-sentry-dsn@sentry.io/production-project
SENTRY_ENVIRONMENT=production
```

#### 4.4.4 High Availability Setup

Production runs **3 backend replicas** for high availability:

```yaml
# docker-compose.prod.yml
services:
  backend:
    deploy:
      replicas: 3
      update_config:
        parallelism: 1           # Update one at a time
        delay: 10s               # Wait 10s between updates
      restart_policy:
        condition: on-failure
        max_attempts: 3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
```

**Load balancing** handled by Nginx:

```nginx
upstream backend {
    least_conn;  # Load balancing algorithm
    server backend-1:8000 weight=1 max_fails=3 fail_timeout=30s;
    server backend-2:8000 weight=1 max_fails=3 fail_timeout=30s;
    server backend-3:8000 weight=1 max_fails=3 fail_timeout=30s;
}
```

#### 4.4.5 SSL/TLS Configuration

Production uses **Certbot** for automated SSL certificate management:

```bash
# Certbot automatically:
# 1. Obtains certificates from Let's Encrypt
# 2. Configures Nginx
# 3. Renews certificates before expiry

# Manual renewal (if needed)
docker-compose -f docker-compose.yml -f docker-compose.prod.yml \
  --env-file .env.prod exec certbot certbot renew

# Verify certificate
openssl s_client -connect api.contravento.com:443 \
  -servername api.contravento.com
```

#### 4.4.6 Post-Deployment Checklist (CRITICAL)

```bash
# [ ] Health check responds
curl https://api.contravento.com/health
# Expected: {"status": "healthy"}

# [ ] API responds
curl https://api.contravento.com/
# Expected: {"message": "Welcome to ContraVento API"}

# [ ] HTTPS works (SSL valid)
curl -I https://api.contravento.com
# Expected: HTTP/2 200, valid certificate

# [ ] API docs NOT accessible (if DEBUG=false)
curl https://api.contravento.com/docs
# Expected: 404 (docs hidden in production)

# [ ] CORS configured correctly
curl -H "Origin: https://contravento.com" \
     -I https://api.contravento.com/health
# Expected: Access-Control-Allow-Origin header

# [ ] Registration works end-to-end
# (Use REST client or frontend)

# [ ] Email verification sent and received
# (Check real inbox)

# [ ] Login works
# [ ] File uploads work
# [ ] Database connections stable
# [ ] Logs show no errors
# [ ] Performance within targets
# [ ] Monitoring active (Sentry, Prometheus, Grafana)
# [ ] Backups running and verified
# [ ] SSL certificate auto-renewal working
```

#### 4.4.7 Monitoring

```bash
# Access Grafana (via Nginx proxy)
https://monitoring.contravento.com

# Or directly (if firewall allows)
http://server-ip:3000

# Prometheus
http://server-ip:9090

# Key metrics to monitor:
# - API response times (p50, p95, p99)
# - Request rate (requests/second)
# - Error rate (5xx responses)
# - Database connection pool usage
# - Redis hit/miss ratio
# - CPU/Memory/Disk usage
# - SSL certificate expiry
```

#### 4.4.8 Scaling

**Vertical Scaling** (increase resources):
```bash
# Edit .env.prod
# Increase database connection pool
DATABASE_POOL_SIZE=50  # Default: 20

# Increase worker processes (backend)
WEB_CONCURRENCY=8      # Default: 4
```

**Horizontal Scaling** (more replicas):
```bash
# Edit docker-compose.prod.yml
services:
  backend:
    deploy:
      replicas: 5  # Increase from 3 to 5
```

**Auto-scaling** (future enhancement):
- Kubernetes Horizontal Pod Autoscaler
- AWS ECS Auto Scaling
- Docker Swarm mode scaling

#### 4.4.9 When to Use

- âœ… Serving real users in production
- âœ… Requires 24/7 uptime
- âœ… Needs automatic failover
- âœ… Compliance requirements (SOC2, HIPAA, GDPR)
- âœ… SLA commitments (99.9% uptime)

---

### 4.5 Configuration Management

#### 4.5.1 Environment Variable Precedence

Docker Compose resolves variables in this order (highest to lowest):

1. **Shell environment variables** (`export VAR=value`)
2. **--env-file parameter** (`.env.<env>`)
3. **Default values in compose file** (`${VAR:-default}`)

#### 4.5.2 Secret Management Best Practices

**âŒ NEVER do this:**
```bash
# Don't commit secrets to Git
git add .env.prod  # âŒ BAD!

# Don't hardcode in Dockerfile
ENV SECRET_KEY=abc123  # âŒ BAD!
```

**âœ… DO this:**
```bash
# Use .gitignore (already configured)
.env
.env.*
!.env.*.example

# Use external secret manager for production
# - AWS Secrets Manager
# - HashiCorp Vault
# - Azure Key Vault
# - Google Secret Manager

# Example: AWS Secrets Manager
aws secretsmanager get-secret-value \
  --secret-id contravento/prod/secret-key \
  --query SecretString --output text
```

#### 4.5.3 Generate Strong Secrets

```bash
# SECRET_KEY (production: min 128 chars)
python -c "import secrets; print(secrets.token_urlsafe(128))"

# Database password (min 48 chars)
openssl rand -base64 48

# Redis password (min 32 chars)
openssl rand -base64 32

# Generate multiple secrets at once
for i in {1..3}; do
  echo "Secret $i: $(python -c 'import secrets; print(secrets.token_urlsafe(64))')"
done
```

#### 4.5.4 Secret Rotation Schedule

| Environment | Rotation Frequency | Automation |
|-------------|-------------------|------------|
| **Production** | Every 90 days | Required |
| **Staging** | Every 180 days | Recommended |
| **Development** | Annually | Manual |
| **After incident** | Immediately | Manual |

#### 4.5.5 Deployment Scripts

ContraVento provides deployment scripts for all environments:

**Linux/Mac** (`deploy.sh`):
```bash
# Start environment
./deploy.sh <env>

# Stop environment
./deploy.sh <env> down

# View logs
./deploy.sh <env> logs

# Show running containers
./deploy.sh <env> ps

# Restart environment
./deploy.sh <env> restart

# Available environments: local-minimal, local, dev, staging, prod
```

**Windows** (`deploy.ps1`):
```powershell
# Same commands as Linux/Mac
.\deploy.ps1 <env>
.\deploy.ps1 <env> down
.\deploy.ps1 <env> logs
.\deploy.ps1 <env> ps
.\deploy.ps1 <env> restart
```

**Manual deployment** (if scripts unavailable):
```bash
# General pattern
docker-compose \
  -f docker-compose.yml \
  -f docker-compose.<env>.yml \
  --env-file .env.<env> \
  up -d

# Example: Start staging
docker-compose \
  -f docker-compose.yml \
  -f docker-compose.staging.yml \
  --env-file .env.staging \
  up -d
```

---

## 5. Traditional & Cloud Deployments

> **Note**: Docker Compose is the **recommended** deployment method. Traditional and cloud deployments are advanced alternatives for specific use cases.

### 5.1 Manual PostgreSQL Setup

For environments where Docker is not available or desired.

#### 5.1.1 Install PostgreSQL

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install postgresql postgresql-contrib

# Start and enable service
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

**macOS:**
```bash
# Using Homebrew
brew install postgresql@16

# Start service
brew services start postgresql@16
```

**Windows:**
```bash
# Download from: https://www.postgresql.org/download/windows/
# Run installer and follow setup wizard
```

#### 5.1.2 Create Database and User

```bash
# Connect as superuser
sudo -u postgres psql

# Create user and database
CREATE USER contravento_user WITH PASSWORD 'your_strong_password';
CREATE DATABASE contravento OWNER contravento_user;
GRANT ALL PRIVILEGES ON DATABASE contravento TO contravento_user;

# Enable extensions
\c contravento
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

# Exit
\q
```

#### 5.1.3 Configure DATABASE_URL

```bash
# In .env file (staging or production)
DATABASE_URL=postgresql+asyncpg://contravento_user:your_strong_password@localhost:5432/contravento

# With SSL (recommended for production)
DATABASE_URL=postgresql+asyncpg://contravento_user:your_strong_password@db.server.com:5432/contravento?ssl=require
```

#### 5.1.4 Test Connection

```bash
# Using psql
psql -h localhost -p 5432 -U contravento_user -d contravento -c "SELECT version();"

# Using Python
python -c "
import asyncio
from sqlalchemy.ext.asyncio import create_async_engine

async def test():
    engine = create_async_engine('postgresql+asyncpg://...')
    async with engine.connect() as conn:
        result = await conn.execute('SELECT version()')
        print(f'PostgreSQL version: {result.scalar()}')
    await engine.dispose()

asyncio.run(test())
"
```

#### 5.1.5 PostgreSQL Performance Tuning

For production deployments, tune PostgreSQL for optimal performance:

```bash
# Edit postgresql.conf (location varies by OS)
# Ubuntu/Debian: /etc/postgresql/16/main/postgresql.conf

# Memory settings (adjust based on available RAM)
shared_buffers = 256MB              # 25% of RAM
effective_cache_size = 1GB          # 50% of RAM
work_mem = 16MB
maintenance_work_mem = 128MB

# Connection settings
max_connections = 200               # Match backend connection pool

# Logging
log_min_duration_statement = 1000   # Log slow queries (>1s)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Reload configuration
sudo systemctl reload postgresql
```

---

### 5.2 Cloud Platform Deployments

#### 5.2.1 AWS (ECS + RDS + ElastiCache)

**Architecture:**
- **ECS Fargate**: Run backend containers
- **RDS PostgreSQL**: Managed database
- **ElastiCache Redis**: Managed cache
- **ALB**: Load balancer
- **S3**: File storage (profile/trip photos)
- **CloudWatch**: Monitoring and logging

**Deployment Steps:**

```bash
# 1. Create RDS PostgreSQL instance
aws rds create-db-instance \
  --db-instance-identifier contravento-prod \
  --db-instance-class db.t3.medium \
  --engine postgres \
  --engine-version 16.1 \
  --master-username contravento_user \
  --master-user-password STRONG_PASSWORD \
  --allocated-storage 50 \
  --backup-retention-period 7 \
  --multi-az \
  --storage-encrypted

# 2. Create ElastiCache Redis
aws elasticache create-cache-cluster \
  --cache-cluster-id contravento-redis \
  --cache-node-type cache.t3.micro \
  --engine redis \
  --engine-version 7.0 \
  --num-cache-nodes 1

# 3. Build and push Docker image to ECR
aws ecr get-login-password --region us-east-1 | \
  docker login --username AWS --password-stdin YOUR_ECR_URL

docker build -t contravento-backend ./backend
docker tag contravento-backend:latest YOUR_ECR_URL/contravento-backend:latest
docker push YOUR_ECR_URL/contravento-backend:latest

# 4. Create ECS Task Definition (JSON)
# See: aws/ecs-task-definition.json

# 5. Create ECS Service
aws ecs create-service \
  --cluster contravento-cluster \
  --service-name backend \
  --task-definition contravento-backend:1 \
  --desired-count 3 \
  --launch-type FARGATE \
  --load-balancers "targetGroupArn=YOUR_TG_ARN,containerName=backend,containerPort=8000"

# 6. Configure environment variables in ECS Task Definition
# Use AWS Secrets Manager for sensitive values
```

**Estimated Monthly Cost** (us-east-1):
- RDS db.t3.medium: ~$60
- ElastiCache cache.t3.micro: ~$15
- ECS Fargate (3 tasks, 0.5 vCPU, 1GB RAM): ~$30
- ALB: ~$20
- **Total**: ~$125/month + data transfer

---

#### 5.2.2 Google Cloud Platform (Cloud Run + Cloud SQL)

**Architecture:**
- **Cloud Run**: Serverless container platform
- **Cloud SQL PostgreSQL**: Managed database
- **Cloud Memorystore**: Managed Redis
- **Cloud Load Balancing**: Load balancer
- **Cloud Storage**: File storage

**Deployment Steps:**

```bash
# 1. Create Cloud SQL instance
gcloud sql instances create contravento-prod \
  --database-version=POSTGRES_16 \
  --tier=db-f1-micro \
  --region=us-central1 \
  --backup \
  --backup-start-time=03:00

# 2. Create database and user
gcloud sql databases create contravento \
  --instance=contravento-prod

gcloud sql users create contravento_user \
  --instance=contravento-prod \
  --password=STRONG_PASSWORD

# 3. Build and push to Container Registry
gcloud builds submit --tag gcr.io/PROJECT_ID/contravento-backend ./backend

# 4. Deploy to Cloud Run
gcloud run deploy contravento-backend \
  --image gcr.io/PROJECT_ID/contravento-backend \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars DATABASE_URL="postgresql+asyncpg://..." \
  --set-secrets SECRET_KEY=contravento-secret-key:latest \
  --min-instances 1 \
  --max-instances 10
```

**Estimated Monthly Cost**:
- Cloud SQL db-f1-micro: ~$10
- Cloud Run (1M requests/month): ~$5
- Cloud Memorystore (1GB): ~$40
- **Total**: ~$55/month

---

#### 5.2.3 Managed Platform Deployments

**Railway** (Fastest deployment):
```bash
# 1. Install Railway CLI
npm install -g @railway/cli

# 2. Login and initialize
railway login
railway init

# 3. Link to project
railway link

# 4. Deploy backend
cd backend
railway up

# 5. Provision PostgreSQL and Redis
railway add --plugin postgresql
railway add --plugin redis

# 6. Set environment variables in Railway dashboard
# DATABASE_URL, REDIS_URL are auto-configured
```

**Render** (Simple deployment):
```yaml
# render.yaml
services:
  - type: web
    name: contravento-backend
    env: docker
    dockerfilePath: ./backend/Dockerfile
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: contravento-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
        sync: false

databases:
  - name: contravento-db
    databaseName: contravento
    user: contravento_user
```

**Fly.io** (Edge deployment):
```bash
# 1. Install flyctl
curl -L https://fly.io/install.sh | sh

# 2. Login and launch
fly auth login
cd backend
fly launch

# 3. Create PostgreSQL
fly postgres create --name contravento-db

# 4. Attach to app
fly postgres attach contravento-db

# 5. Deploy
fly deploy
```

---

#### 5.2.4 Kubernetes Deployment

**For advanced users** requiring maximum scalability and control.

**Prerequisites:**
- Kubernetes cluster (EKS, GKE, AKS, or self-managed)
- `kubectl` CLI installed
- Helm 3+ (optional but recommended)

**Deployment Steps:**

```yaml
# 1. Create namespace
apiVersion: v1
kind: Namespace
metadata:
  name: contravento

---
# 2. Create secrets
apiVersion: v1
kind: Secret
metadata:
  name: contravento-secrets
  namespace: contravento
type: Opaque
stringData:
  database-url: postgresql+asyncpg://...
  secret-key: YOUR_SECRET_KEY
  redis-url: redis://...

---
# 3. Backend deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: contravento-backend
  namespace: contravento
spec:
  replicas: 3
  selector:
    matchLabels:
      app: contravento-backend
  template:
    metadata:
      labels:
        app: contravento-backend
    spec:
      containers:
      - name: backend
        image: your-registry/contravento-backend:latest
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: contravento-secrets
              key: database-url
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: contravento-secrets
              key: secret-key
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5

---
# 4. Service
apiVersion: v1
kind: Service
metadata:
  name: contravento-backend
  namespace: contravento
spec:
  selector:
    app: contravento-backend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8000
  type: ClusterIP

---
# 5. Ingress (with SSL)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: contravento-ingress
  namespace: contravento
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - api.contravento.com
    secretName: contravento-tls
  rules:
  - host: api.contravento.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: contravento-backend
            port:
              number: 80
```

**Deploy to Kubernetes:**
```bash
# Apply all manifests
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/secrets.yaml
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml
kubectl apply -f k8s/ingress.yaml

# Check status
kubectl get pods -n contravento
kubectl get svc -n contravento
kubectl get ingress -n contravento

# View logs
kubectl logs -f deployment/contravento-backend -n contravento
```

---

## 6. Database Management

### 6.1 PostgreSQL Setup Options

See [Section 5.1](#51-manual-postgresql-setup) for manual installation.

**Managed PostgreSQL Providers:**

| Provider | Pros | Cons | Pricing |
|----------|------|------|---------|
| **AWS RDS** | Full-featured, automated backups, multi-AZ | More expensive | ~$60/month (t3.medium) |
| **Google Cloud SQL** | Auto-scaling, easy GCP integration | Regional only | ~$10/month (db-f1-micro) |
| **Azure Database** | Azure integration, flexible scaling | Complex pricing | ~$50/month (B2s) |
| **Supabase** | PostgreSQL + extras (Auth, Storage, Realtime) | Limited control | Free tier + $25/month |
| **Railway** | Fast setup, generous free tier | Newer service | Free tier + $5/month |
| **Neon** | Serverless PostgreSQL, instant scaling | Beta features | Free tier + $20/month |

**Recommendation:**
- **Development/Staging**: Railway or Supabase (easy, affordable)
- **Production**: AWS RDS or Google Cloud SQL (enterprise-grade)

---

### 6.2 Migrations

ContraVento uses **Alembic** for database migrations.

#### 6.2.1 Apply Migrations

```bash
# With Docker
docker-compose exec backend alembic upgrade head

# Local (with Poetry)
cd backend
poetry run alembic upgrade head

# Specific version
poetry run alembic upgrade <revision_id>

# Upgrade one step
poetry run alembic upgrade +1
```

#### 6.2.2 View Migration Status

```bash
# Current version
alembic current

# Full history
alembic history

# Pending migrations
alembic heads

# Preview SQL (dry-run)
alembic upgrade head --sql > migration.sql
```

#### 6.2.3 Existing Migrations

**User Profiles (001-user-profiles):**

| Migration | Description |
|-----------|-------------|
| `001_initial_auth_schema.py` | Users, profiles, password resets |
| `002_add_privacy_settings.py` | Privacy columns (profile_privacy, stats_privacy) |
| `003_stats_and_achievements.py` | UserStats, Achievements, UserAchievements |
| `004_social_features.py` | Follows (follow relationships) |

**Travel Diary (002-travel-diary):**

| Migration | Description |
|-----------|-------------|
| `005_travel_diary_trips.py` | Trips, TripPhotos, TripLocations, Tags |
| `006_trip_tags_association.py` | trip_tags (many-to-many association table) |

#### 6.2.4 Create New Migration

```bash
# Auto-generate from SQLAlchemy models
alembic revision --autogenerate -m "add new feature"

# Manual migration (for complex changes)
alembic revision -m "add custom index"

# Edit generated file
nano migrations/versions/xxx_add_new_feature.py

# Review and test before applying
alembic upgrade head --sql  # Preview SQL
alembic upgrade head        # Apply
```

#### 6.2.5 Rollback Migrations

```bash
# Rollback last migration
alembic downgrade -1

# Rollback to specific version
alembic downgrade <revision_id>

# Rollback all (âš ï¸  CAUTION: Deletes all tables)
alembic downgrade base
```

#### 6.2.6 Testing Migrations

**Full migration test cycle:**
```bash
# 1. Rollback all migrations
alembic downgrade base

# 2. Verify only alembic_version remains
docker exec contravento-db psql -U contravento_user -d contravento -c "\dt"

# 3. Apply all migrations
alembic upgrade head

# 4. Verify all tables created
docker exec contravento-db psql -U contravento_user -d contravento -c "\dt"

# Expected tables:
# - users, user_profiles, password_resets
# - user_stats, achievements, user_achievements
# - follows
# - trips, trip_photos, trip_locations, tags, trip_tags
# - alembic_version
```

**Step-by-step migration test:**
```bash
# View all migrations
alembic history

# Start from base
alembic downgrade base

# Apply one migration at a time
alembic upgrade +1
docker exec contravento-db psql -U contravento_user -d contravento -c "\dt"

alembic upgrade +1
docker exec contravento-db psql -U contravento_user -d contravento -c "\dt"

# Continue until head
alembic upgrade head
```

**Verify constraints and indexes:**
```bash
# View foreign keys
docker exec contravento-db psql -U contravento_user -d contravento -c "
  SELECT
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
  FROM information_schema.table_constraints AS tc
  JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
  JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
  WHERE tc.constraint_type = 'FOREIGN KEY'
  ORDER BY tc.table_name;
"

# View indexes
docker exec contravento-db psql -U contravento_user -d contravento -c "
  SELECT
    tablename,
    indexname,
    indexdef
  FROM pg_indexes
  WHERE schemaname = 'public'
  ORDER BY tablename, indexname;
"
```

---

### 6.3 Backup & Recovery

#### 6.3.1 Manual Database Backup

```bash
# Full backup
docker exec contravento-db pg_dump -U contravento_user contravento > backup_$(date +%Y%m%d_%H%M%S).sql

# Compressed backup
docker exec contravento-db pg_dump -U contravento_user contravento | \
  gzip > backup_$(date +%Y%m%d_%H%M%S).sql.gz

# Schema only (no data)
docker exec contravento-db pg_dump -U contravento_user --schema-only contravento > schema_$(date +%Y%m%d).sql

# Data only (no schema)
docker exec contravento-db pg_dump -U contravento_user --data-only contravento > data_$(date +%Y%m%d).sql
```

#### 6.3.2 Automated Backups (Cron)

```bash
# Edit crontab
crontab -e

# Daily backup at 2 AM (retain 30 days)
0 2 * * * docker exec contravento-db pg_dump -U contravento_user contravento | gzip > /backups/contravento_$(date +\%Y\%m\%d).sql.gz

# Clean old backups (retain last 30 days)
0 3 * * * find /backups -name "contravento_*.sql.gz" -mtime +30 -delete

# Weekly full backup to external storage
0 4 * * 0 /usr/local/bin/backup-to-s3.sh
```

#### 6.3.3 Backup to AWS S3

```bash
#!/bin/bash
# /usr/local/bin/backup-to-s3.sh

BACKUP_FILE=contravento_$(date +%Y%m%d_%H%M%S).sql.gz
BACKUP_DIR=/tmp/backups

# Create backup
docker exec contravento-db pg_dump -U contravento_user contravento | \
  gzip > $BACKUP_DIR/$BACKUP_FILE

# Upload to S3
aws s3 cp $BACKUP_DIR/$BACKUP_FILE s3://contravento-backups/database/

# Clean local backup
rm $BACKUP_DIR/$BACKUP_FILE

# Lifecycle policy: Transition to Glacier after 30 days, delete after 365 days
```

#### 6.3.4 Restore Database

```bash
# Restore from uncompressed backup
docker exec -i contravento-db psql -U contravento_user contravento < backup_20250108.sql

# Restore from compressed backup
gunzip < backup_20250108.sql.gz | \
  docker exec -i contravento-db psql -U contravento_user contravento

# Restore from S3
aws s3 cp s3://contravento-backups/database/backup_20250108.sql.gz - | \
  gunzip | \
  docker exec -i contravento-db psql -U contravento_user contravento
```

#### 6.3.5 File Storage Backup

Backup uploaded files (profile photos, trip photos):

```bash
# Local backup (compressed archive)
tar -czf storage_backup_$(date +%Y%m%d).tar.gz backend/storage/

# Sync to S3 (incremental)
aws s3 sync backend/storage/ s3://contravento-backups/storage/ --delete

# Restore from S3
aws s3 sync s3://contravento-backups/storage/ backend/storage/

# Alternative: Use rsync for remote backups
rsync -avz backend/storage/ backup-server:/backups/contravento/storage/
```

#### 6.3.6 Disaster Recovery Testing

**Test backup restoration quarterly:**
```bash
# 1. Create test database
docker exec contravento-db psql -U postgres -c "CREATE DATABASE contravento_restore_test;"

# 2. Restore latest backup
gunzip < backup_latest.sql.gz | \
  docker exec -i contravento-db psql -U contravento_user contravento_restore_test

# 3. Verify data integrity
docker exec contravento-db psql -U contravento_user contravento_restore_test -c "
  SELECT COUNT(*) FROM users;
  SELECT COUNT(*) FROM trips;
  SELECT COUNT(*) FROM trip_photos;
"

# 4. Clean up
docker exec contravento-db psql -U postgres -c "DROP DATABASE contravento_restore_test;"
```

---

## 7. Reverse Proxy & SSL

### 7.1 Why Use Nginx

**Benefits:**
- **HTTPS/SSL Termination**: Handles TLS certificates, offloads encryption from backend
- **Static File Serving**: Efficiently serves uploaded photos (profile, trip photos)
- **Load Balancing**: Distributes traffic across multiple backend instances
- **Caching**: Reduces backend load with smart caching
- **Security Headers**: Adds HSTS, CSP, X-Frame-Options, etc.
- **Rate Limiting**: Prevents abuse and DDoS attacks
- **Compression**: Gzip compression reduces bandwidth

---

### 7.2 Nginx Configuration

**Production-ready Nginx config:**

```nginx
# /etc/nginx/sites-available/contravento

# Upstream backend (multiple instances for load balancing)
upstream backend {
    least_conn;  # Load balancing algorithm
    server backend-1:8000 weight=1 max_fails=3 fail_timeout=30s;
    server backend-2:8000 weight=1 max_fails=3 fail_timeout=30s;
    server backend-3:8000 weight=1 max_fails=3 fail_timeout=30s;
}

# HTTP -> HTTPS redirect
server {
    listen 80;
    server_name contravento.com www.contravento.com;

    # Allow Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS server
server {
    listen 443 ssl http2;
    server_name contravento.com www.contravento.com;

    # SSL Configuration (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/contravento.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/contravento.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: https:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;

    # Max upload size (match UPLOAD_MAX_SIZE_MB in backend)
    client_max_body_size 10M;

    # Compression
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;

    # Proxy to FastAPI backend
    location / {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (future)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Login endpoint (stricter rate limit)
    location /auth/login {
        limit_req zone=login_limit burst=2 nodelay;
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Static files - Profile photos
    location /storage/profile_photos/ {
        alias /app/storage/profile_photos/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Static files - Trip photos
    location /storage/trip_photos/ {
        alias /app/storage/trip_photos/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Health check (no logs, no rate limit)
    location /health {
        proxy_pass http://backend;
        access_log off;
    }

    # Logs
    access_log /var/log/nginx/contravento_access.log;
    error_log /var/log/nginx/contravento_error.log;
}
```

---

### 7.3 Install and Configure Nginx

**Ubuntu/Debian:**
```bash
# Install Nginx
sudo apt-get update
sudo apt-get install nginx

# Copy configuration
sudo nano /etc/nginx/sites-available/contravento

# Create symlink
sudo ln -s /etc/nginx/sites-available/contravento /etc/nginx/sites-enabled/

# Test configuration
sudo nginx -t

# Reload Nginx
sudo systemctl reload nginx

# Enable at boot
sudo systemctl enable nginx
```

**macOS:**
```bash
# Install Nginx
brew install nginx

# Copy configuration
sudo nano /opt/homebrew/etc/nginx/servers/contravento.conf

# Test configuration
nginx -t

# Restart Nginx
brew services restart nginx
```

---

### 7.4 SSL with Let's Encrypt

**Automated SSL certificate setup:**

```bash
# Install Certbot
sudo apt-get install certbot python3-certbot-nginx

# Obtain certificate (automatic Nginx configuration)
sudo certbot --nginx -d contravento.com -d www.contravento.com

# Test automatic renewal
sudo certbot renew --dry-run

# Certificate auto-renews via systemd timer (Ubuntu) or cron
# Verify timer
sudo systemctl list-timers | grep certbot
```

**Manual certificate renewal:**
```bash
# Renew all certificates
sudo certbot renew

# Renew specific certificate
sudo certbot renew --cert-name contravento.com

# Reload Nginx after renewal
sudo systemctl reload nginx
```

**Docker Certbot** (used in production environment):
```bash
# Certbot runs as separate container
# See docker-compose.prod.yml

# Manual renewal
docker-compose -f docker-compose.yml -f docker-compose.prod.yml \
  --env-file .env.prod exec certbot certbot renew

# Certbot container automatically renews certificates
# Nginx automatically reloads on certificate update
```

---

### 7.5 Nginx Monitoring

```bash
# Check Nginx status
sudo systemctl status nginx

# View access logs (real-time)
sudo tail -f /var/log/nginx/contravento_access.log

# View error logs
sudo tail -f /var/log/nginx/contravento_error.log

# Monitor connections
sudo watch -n 1 'ss -tln | grep :443'

# Nginx stats (requires stub_status module)
curl http://localhost/nginx_status
```

---

## 8. Monitoring & Logging

### 8.1 Health Checks

**Backend health endpoint:**
```bash
# Backend health
curl https://contravento.com/health
# Expected: {"status": "healthy"}

# Database health
docker exec contravento-db pg_isready -U contravento_user
# Expected: contravento-db:5432 - accepting connections

# Redis health
docker exec contravento-redis redis-cli --no-auth-warning -a YOUR_PASSWORD ping
# Expected: PONG
```

**Automated health monitoring:**
```bash
# Create health check script
#!/bin/bash
# /usr/local/bin/health-check.sh

BACKEND_URL="https://contravento.com/health"
ALERT_EMAIL="alerts@contravento.com"

# Check backend
if ! curl -f -s $BACKEND_URL > /dev/null; then
  echo "Backend health check failed" | mail -s "ALERT: Backend Down" $ALERT_EMAIL
  exit 1
fi

# Check database
if ! docker exec contravento-db pg_isready -U contravento_user > /dev/null; then
  echo "Database health check failed" | mail -s "ALERT: Database Down" $ALERT_EMAIL
  exit 1
fi

exit 0

# Add to cron (check every 5 minutes)
*/5 * * * * /usr/local/bin/health-check.sh
```

---

### 8.2 Application Logs

**View logs:**
```bash
# Docker logs (real-time)
docker-compose logs -f backend
docker-compose logs -f postgres
docker-compose logs -f redis

# Last 100 lines
docker-compose logs --tail=100 backend

# Since timestamp
docker-compose logs --since 2025-01-08T10:00:00 backend

# Only errors
docker-compose logs backend | grep ERROR
docker-compose logs backend | grep -E "ERROR|CRITICAL"

# Save logs to file
docker-compose logs --since 24h backend > backend_logs_$(date +%Y%m%d).log
```

**Log aggregation** (production):
```bash
# Configure log driver in docker-compose.prod.yml
services:
  backend:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Or use centralized logging (Logstash, Fluentd, CloudWatch)
```

---

### 8.3 System Metrics

**Container stats:**
```bash
# Real-time stats (CPU, memory, network, disk I/O)
docker stats

# Specific container
docker stats contravento-backend

# Non-interactive (one-shot)
docker stats --no-stream
```

**Database metrics:**
```bash
# Active connections
docker exec contravento-db psql -U contravento_user -d contravento -c "
SELECT
  count(*) as total_connections,
  count(*) FILTER (WHERE state = 'active') as active,
  count(*) FILTER (WHERE state = 'idle') as idle
FROM pg_stat_activity
WHERE datname = 'contravento';
"

# Database size
docker exec contravento-db psql -U contravento_user -d contravento -c "
SELECT pg_size_pretty(pg_database_size('contravento')) as db_size;
"

# Table sizes
docker exec contravento-db psql -U contravento_user -d contravento -c "
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
"

# Slow queries (requires pg_stat_statements extension)
docker exec contravento-db psql -U contravento_user -d contravento -c "
SELECT
  query,
  calls,
  total_time,
  mean_time,
  max_time
FROM pg_stat_statements
WHERE mean_time > 1000
ORDER BY mean_time DESC
LIMIT 10;
"
```

**Redis metrics:**
```bash
# Redis info
docker exec contravento-redis redis-cli --no-auth-warning -a YOUR_PASSWORD INFO stats
docker exec contravento-redis redis-cli --no-auth-warning -a YOUR_PASSWORD INFO memory

# Key count
docker exec contravento-redis redis-cli --no-auth-warning -a YOUR_PASSWORD DBSIZE

# Memory usage
docker exec contravento-redis redis-cli --no-auth-warning -a YOUR_PASSWORD INFO memory | grep used_memory_human
```

---

### 8.4 Error Tracking (Sentry)

**Setup Sentry:**
```bash
# 1. Create account at sentry.io
# 2. Create project (Python/FastAPI)
# 3. Copy DSN

# 4. Configure in .env
SENTRY_DSN=https://your-dsn@sentry.io/project-id
SENTRY_ENVIRONMENT=production

# 5. Sentry automatically captures:
# - Unhandled exceptions
# - HTTP errors (500+)
# - Performance issues
# - Custom events

# 6. View errors at https://sentry.io/organizations/your-org/issues/
```

**Custom Sentry events:**
```python
# backend/src/main.py
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn=settings.sentry_dsn,
    environment=settings.sentry_environment,
    traces_sample_rate=0.1,  # 10% of transactions
    integrations=[FastApiIntegration()],
)

# Custom error tracking
try:
    risky_operation()
except Exception as e:
    sentry_sdk.capture_exception(e)
    raise
```

---

### 8.5 Uptime Monitoring

**External monitoring services:**

| Service | Free Tier | Interval | Alerts |
|---------|-----------|----------|--------|
| **UptimeRobot** | 50 monitors | 5 min | Email, SMS, Webhook |
| **Pingdom** | 1 monitor | 1 min | Email |
| **StatusCake** | 10 monitors | 5 min | Email, SMS |
| **Better Uptime** | 10 monitors | 3 min | Email, Slack, PagerDuty |

**Setup UptimeRobot:**
1. Create account at uptimerobot.com
2. Add HTTP(S) monitor
   - URL: `https://contravento.com/health`
   - Interval: 5 minutes
   - Alert contacts: Email, Slack
3. Configure alert threshold: Down after 2 failed checks
4. Create status page (public or private)

---

### 8.6 Monitoring Stack (Prometheus + Grafana)

**Included in staging and production environments.**

**Prometheus** (metrics collection):
- URL: http://localhost:9090 (or https://monitoring.contravento.com/prometheus)
- Scrapes metrics from:
  - FastAPI backend (`/metrics` endpoint)
  - PostgreSQL exporter
  - Redis exporter
  - Node exporter (system metrics)
- Retention: 30 days

**Grafana** (visualization):
- URL: http://localhost:3000 (or https://monitoring.contravento.com)
- Default credentials: See `.env.<env>` (`GRAFANA_ADMIN_USER/PASSWORD`)
- Pre-configured dashboards:
  - FastAPI Application Metrics
  - PostgreSQL Performance
  - Redis Performance
  - System Metrics (CPU, RAM, Disk, Network)

**Key Metrics:**
- **API Performance**: Response times (p50, p95, p99), request rate, error rate
- **Database**: Connection pool usage, query latency, slow queries
- **Redis**: Hit/miss ratio, memory usage, evicted keys
- **System**: CPU usage, memory usage, disk I/O, network I/O

**Alerting:**
Configure alerts in Prometheus or Grafana for:
- API error rate > 1%
- API p95 latency > 500ms
- Database connection pool > 80% full
- Disk usage > 85%
- Memory usage > 90%

---

## 9. Security

### 9.1 Pre-Deployment Security Checklist

**Environment Variables:**
- [ ] `SECRET_KEY` is unique per environment (min 64 chars for staging, 128 chars for production)
- [ ] `DB_PASSWORD` is strong (min 32 chars, randomly generated)
- [ ] `REDIS_PASSWORD` is strong (min 32 chars, randomly generated)
- [ ] No default passwords ("changeme", "admin", "password123")
- [ ] `.env.prod` is in `.gitignore` (never committed)
- [ ] Secrets stored in external secret manager (AWS Secrets Manager, Vault, etc.) for production

**HTTPS/SSL:**
- [ ] HTTPS enforced (HTTP redirects to HTTPS)
- [ ] SSL certificate valid and not expired
- [ ] TLS 1.2+ only (no TLS 1.0/1.1)
- [ ] Security headers configured (HSTS, X-Frame-Options, CSP, etc.)
- [ ] SSL certificate auto-renewal working

**CORS:**
- [ ] `CORS_ORIGINS` restricted to specific production domains only
- [ ] No wildcard `*` (allow all origins)
- [ ] No `localhost` in production CORS_ORIGINS

**Database:**
- [ ] PostgreSQL in production (not SQLite)
- [ ] Database user with minimal necessary permissions (not superuser)
- [ ] Database connections use SSL/TLS
- [ ] Automated backups configured and tested
- [ ] Backup restoration tested successfully

**Authentication:**
- [ ] `BCRYPT_ROUNDS=12` or higher (14 recommended for production)
- [ ] Rate limiting enabled (LOGIN_MAX_ATTEMPTS=5)
- [ ] Account lockout configured (LOGIN_LOCKOUT_MINUTES=15)
- [ ] JWT tokens expire appropriately (15min access, 30 days refresh)
- [ ] Refresh token rotation enabled

**Application:**
- [ ] `DEBUG=false` in production (CRITICAL)
- [ ] API docs hidden in production (`/docs`, `/redoc` return 404)
- [ ] Error messages don't expose stack traces to users
- [ ] File uploads validated (type, size, content)
- [ ] HTML sanitization enabled (XSS prevention)
- [ ] SQL injection prevention (ORM only, no raw SQL)

**Infrastructure:**
- [ ] Firewall configured (only ports 80, 443 exposed publicly)
- [ ] SSH with key-based auth only (no password auth)
- [ ] Containers run as non-root user
- [ ] Secrets not hardcoded in Dockerfile or docker-compose.yml
- [ ] Docker images from trusted sources only

---

### 9.2 Post-Deployment Security

**Regular Tasks:**
- [ ] Vulnerability scanning (Snyk, Trivy, Dependabot)
- [ ] Dependency updates (weekly security patches, monthly major updates)
- [ ] Log monitoring for suspicious activities (failed logins, SQL injection attempts)
- [ ] Penetration testing (quarterly for production)
- [ ] Security audit (annually)
- [ ] Incident response plan documented and tested

**Security Monitoring:**
```bash
# Monitor failed login attempts
docker-compose logs backend | grep "LOGIN_FAILED"

# Monitor 401/403 responses (unauthorized access attempts)
docker-compose logs backend | grep -E "401|403"

# Monitor unusual activity
docker-compose logs backend | grep -E "SUSPICIOUS|BLOCKED"
```

---

### 9.3 Security Hardening

**Nginx security headers** (already included in [Section 7.2](#72-nginx-configuration)):
```nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Content-Security-Policy "default-src 'self';" always;
```

**Rate limiting** (Nginx):
```nginx
# Limit login attempts
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

location /auth/login {
    limit_req zone=login_limit burst=2 nodelay;
    # ... proxy settings
}
```

**Database security:**
```bash
# Use least-privilege database user
CREATE USER contravento_app WITH PASSWORD 'strong_password';
GRANT CONNECT ON DATABASE contravento TO contravento_app;
GRANT USAGE ON SCHEMA public TO contravento_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO contravento_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO contravento_app;

# Revoke superuser privileges
REVOKE ALL PRIVILEGES ON DATABASE postgres FROM contravento_app;
```

---

### 9.4 Vulnerability Scanning

**Scan Docker images:**
```bash
# Install Trivy
brew install trivy  # macOS
sudo apt-get install trivy  # Ubuntu

# Scan backend image
trivy image your-registry/contravento-backend:latest

# Scan with severity filter (only HIGH and CRITICAL)
trivy image --severity HIGH,CRITICAL your-registry/contravento-backend:latest

# Generate report
trivy image -f json -o trivy-report.json your-registry/contravento-backend:latest
```

**Scan Python dependencies:**
```bash
# Install Safety
pip install safety

# Scan for known vulnerabilities
cd backend
safety check

# Or use Snyk
npm install -g snyk
snyk test
```

---

## 10. Scaling & Performance

### 10.1 Horizontal Scaling (Multiple Instances)

**Docker Compose** (replicas):
```yaml
# docker-compose.prod.yml
services:
  backend:
    deploy:
      replicas: 3  # Increase to 5, 10, etc.
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
```

**Kubernetes** (auto-scaling):
```yaml
# k8s/hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: contravento-backend-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: contravento-backend
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

---

### 10.2 Load Balancing

**Nginx** (already configured in [Section 7.2](#72-nginx-configuration)):
```nginx
upstream backend {
    least_conn;  # Load balancing algorithms:
                 # - least_conn: Route to server with fewest connections
                 # - ip_hash: Sticky sessions based on client IP
                 # - round_robin: Default, equal distribution

    server backend-1:8000 weight=1 max_fails=3 fail_timeout=30s;
    server backend-2:8000 weight=1 max_fails=3 fail_timeout=30s;
    server backend-3:8000 weight=1 max_fails=3 fail_timeout=30s;
}
```

---

### 10.3 Database Scaling

**Connection Pooling:**
```python
# backend/src/config.py
class Settings(BaseSettings):
    database_pool_size: int = 20  # Default connections
    database_max_overflow: int = 10  # Additional connections when needed
    database_pool_timeout: int = 30  # Seconds to wait for connection
    database_pool_recycle: int = 3600  # Recycle connections after 1 hour
```

**Read Replicas:**
```python
# config.py
class Settings(BaseSettings):
    database_write_url: str  # Primary database (writes)
    database_read_url: str  # Read replica (reads)

# Use read replica for GET requests
async def get_user(db: AsyncSession):
    # db session connected to read replica
    result = await db.execute(select(User).where(User.id == user_id))
    return result.scalar_one()
```

**PostgreSQL Performance Tuning:**
```sql
-- postgresql.conf

-- Memory (adjust based on available RAM)
shared_buffers = 4GB                # 25% of RAM
effective_cache_size = 12GB         # 75% of RAM
work_mem = 32MB
maintenance_work_mem = 512MB

-- Connections
max_connections = 200

-- Query optimization
random_page_cost = 1.1              # For SSD
effective_io_concurrency = 200      # For SSD

-- Logging
log_min_duration_statement = 1000   # Log slow queries (>1s)
```

---

### 10.4 Caching Strategy

**Redis caching:**
```python
# backend/src/services/cache_service.py
import redis.asyncio as redis

class CacheService:
    def __init__(self):
        self.redis = redis.from_url(settings.redis_url)

    async def get_user_profile(self, username: str):
        # Try cache first
        cached = await self.redis.get(f"profile:{username}")
        if cached:
            return json.loads(cached)

        # Cache miss - fetch from database
        profile = await ProfileService.get_by_username(db, username)

        # Store in cache (TTL: 1 hour)
        await self.redis.setex(
            f"profile:{username}",
            3600,
            json.dumps(profile.dict())
        )

        return profile
```

**Nginx caching:**
```nginx
# Cache static files
location /storage/ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}

# Cache API responses (careful with authenticated content)
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m;

location /api/public/ {
    proxy_cache api_cache;
    proxy_cache_valid 200 10m;
    add_header X-Cache-Status $upstream_cache_status;
    proxy_pass http://backend;
}
```

---

### 10.5 CDN for Static Assets

**Use CDN for uploaded files:**

```python
# config.py
class Settings(BaseSettings):
    cdn_url: str = "https://cdn.contravento.com"
    storage_backend: str = "s3"  # or "local"

# Return CDN URLs for photos
def get_photo_url(photo_path: str) -> str:
    if settings.storage_backend == "s3":
        return f"{settings.cdn_url}/{photo_path}"
    return f"/storage/{photo_path}"
```

**Popular CDN providers:**
- **Cloudflare** (free tier available)
- **AWS CloudFront**
- **Fastly**
- **BunnyCDN** (affordable)

---

### 10.6 Performance Monitoring

**Target performance metrics:**
- **Auth endpoints**: < 500ms (p95)
- **Profile endpoints**: < 200ms (p95)
- **Trip list**: < 300ms (p95)
- **File uploads**: < 2s (5MB photo)

**Monitor with Prometheus:**
```python
# backend/src/middleware/metrics.py
from prometheus_client import Histogram

REQUEST_DURATION = Histogram(
    'http_request_duration_seconds',
    'HTTP request duration',
    ['method', 'endpoint']
)

@app.middleware("http")
async def metrics_middleware(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    duration = time.time() - start_time

    REQUEST_DURATION.labels(
        method=request.method,
        endpoint=request.url.path
    ).observe(duration)

    return response
```

---

## 11. CI/CD Integration

### 11.1 GitHub Actions Example

**Full CI/CD pipeline:**

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd backend
          pip install poetry
          poetry install

      - name: Run linters
        run: |
          cd backend
          poetry run black --check src/ tests/
          poetry run ruff check src/ tests/
          poetry run mypy src/

      - name: Run tests
        run: |
          cd backend
          poetry run pytest --cov=src --cov-fail-under=90

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: yourorg/contravento-backend:latest,yourorg/contravento-backend:${{ github.sha }}
          cache-from: type=registry,ref=yourorg/contravento-backend:buildcache
          cache-to: type=registry,ref=yourorg/contravento-backend:buildcache,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /app/contravento
            git pull origin main
            docker-compose --env-file .env.prod pull
            docker-compose --env-file .env.prod up -d --no-build
            docker-compose --env-file .env.prod exec -T backend alembic upgrade head

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://api.contravento.com/health || exit 1

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Production deployment failed!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

---

### 11.2 GitLab CI/CD Example

```yaml
# .gitlab-ci.yml
stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

test:
  stage: test
  image: python:3.11
  script:
    - cd backend
    - pip install poetry
    - poetry install
    - poetry run black --check src/ tests/
    - poetry run ruff check src/ tests/
    - poetry run mypy src/
    - poetry run pytest --cov=src --cov-fail-under=90
  coverage: '/TOTAL.*\s+(\d+%)$/'

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE:latest ./backend
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main

deploy_production:
  stage: deploy
  script:
    - apt-get update -qq && apt-get install -y openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "
        cd /app/contravento &&
        git pull origin main &&
        docker-compose --env-file .env.prod pull &&
        docker-compose --env-file .env.prod up -d --no-build &&
        docker-compose --env-file .env.prod exec -T backend alembic upgrade head
      "
  only:
    - main
  when: manual
```

---

### 11.3 Pre-Deployment Checks

**Automated checks before deployment:**

```bash
#!/bin/bash
# scripts/pre-deploy-check.sh

set -e

echo "Running pre-deployment checks..."

# 1. Test coverage >= 90%
echo "Checking test coverage..."
cd backend
poetry run pytest --cov=src --cov-fail-under=90 --quiet

# 2. All tests pass
echo "Running all tests..."
poetry run pytest

# 3. Linters pass
echo "Running linters..."
poetry run black --check src/ tests/
poetry run ruff check src/ tests/
poetry run mypy src/

# 4. Migrations are up to date
echo "Checking migrations..."
poetry run alembic check

# 5. Security scan
echo "Scanning for vulnerabilities..."
poetry run safety check

# 6. Build Docker image
echo "Building Docker image..."
cd ..
docker build -t contravento-backend:test ./backend

# 7. Test container starts
echo "Testing container..."
docker run --rm -d --name contravento-test -p 8001:8000 contravento-backend:test
sleep 5
curl -f http://localhost:8001/health || (docker stop contravento-test && exit 1)
docker stop contravento-test

echo "âœ… All pre-deployment checks passed!"
```

---

## 12. Troubleshooting

### 12.1 Backend Won't Start

**Symptoms:** Backend container exits immediately or crashes in loop.

**Diagnosis:**
```bash
# View logs
docker-compose logs backend

# Check container status
docker-compose ps backend

# Inspect container
docker inspect contravento-backend
```

**Common Causes & Solutions:**

| Issue | Symptom | Solution |
|-------|---------|----------|
| **DATABASE_URL incorrect** | `asyncpg.exceptions.InvalidPasswordError` | Verify `DATABASE_URL` matches PostgreSQL credentials |
| **SECRET_KEY missing** | `ValidationError: SECRET_KEY` | Generate and set `SECRET_KEY` (min 64 chars) |
| **Migrations not applied** | `ProgrammingError: relation "users" does not exist` | Run `alembic upgrade head` |
| **Port 8000 occupied** | `OSError: [Errno 48] Address already in use` | Stop conflicting service or change `BACKEND_PORT` |
| **Storage permissions** | `PermissionError: /app/storage` | Run `chmod -R 755 backend/storage` |

**Detailed troubleshooting:**
```bash
# 1. Check environment variables
docker-compose exec backend env | grep -E "DATABASE_URL|SECRET_KEY|REDIS_URL"

# 2. Test database connection
docker-compose exec backend python -c "
import asyncio
from sqlalchemy.ext.asyncio import create_async_engine
from src.config import settings

async def test():
    try:
        engine = create_async_engine(settings.database_url)
        async with engine.connect():
            print('âœ… Database connection successful')
        await engine.dispose()
    except Exception as e:
        print(f'âŒ Database connection failed: {e}')

asyncio.run(test())
"

# 3. Check migrations
docker-compose exec backend alembic current

# 4. Restart backend
docker-compose restart backend
```

---

### 12.2 Database Connection Failed

**Symptoms:** Backend can't connect to PostgreSQL.

**Diagnosis:**
```bash
# Check if PostgreSQL is running
docker-compose ps postgres

# Check PostgreSQL health
docker exec contravento-db pg_isready -U contravento_user

# View PostgreSQL logs
docker-compose logs postgres

# Test connection manually
docker exec contravento-db psql -U contravento_user -d contravento -c "SELECT 1"
```

**Common Causes & Solutions:**

| Issue | Solution |
|-------|----------|
| PostgreSQL not started | `docker-compose up postgres -d` |
| Wrong credentials | Verify `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB` match `DATABASE_URL` |
| Database doesn't exist | Create database: `docker exec contravento-db psql -U postgres -c "CREATE DATABASE contravento;"` |
| Network issue | Check Docker network: `docker network inspect contravento_default` |

**Reset database** (âš ï¸  DELETES ALL DATA):
```bash
# Stop all services
docker-compose down

# Delete PostgreSQL volume
docker volume rm contravento_postgres_data

# Restart services
docker-compose up -d

# Apply migrations
docker-compose exec backend alembic upgrade head
```

---

### 12.3 Migrations Failed

**Symptoms:** `alembic upgrade head` fails with errors.

**Diagnosis:**
```bash
# Check current migration version
docker-compose exec backend alembic current

# View migration history
docker-compose exec backend alembic history

# Check database version
docker exec contravento-db psql -U contravento_user -d contravento -c \
  "SELECT * FROM alembic_version;"
```

**Common Issues:**

**Issue 1: Conflicting migration heads**
```bash
# Symptom: "Multiple heads found"
# Solution: Merge migration heads
docker-compose exec backend alembic merge heads -m "merge conflicts"
docker-compose exec backend alembic upgrade head
```

**Issue 2: Migration already applied but alembic doesn't know**
```bash
# Symptom: "Table already exists"
# Solution: Stamp database without running migrations
docker-compose exec backend alembic stamp head
```

**Issue 3: Migration partially applied**
```bash
# Solution 1: Rollback and re-apply
docker-compose exec backend alembic downgrade -1
docker-compose exec backend alembic upgrade head

# Solution 2: Manual fix in database then stamp
docker exec contravento-db psql -U contravento_user -d contravento
# ... manually fix schema ...
docker-compose exec backend alembic stamp head
```

---

### 12.4 502 Bad Gateway (Nginx)

**Symptoms:** Nginx returns 502 error.

**Diagnosis:**
```bash
# Check if backend is running
docker-compose ps backend

# Check backend health
curl http://localhost:8000/health

# View Nginx error logs
sudo tail -f /var/log/nginx/error.log

# View Nginx access logs
sudo tail -f /var/log/nginx/access.log

# Test Nginx configuration
sudo nginx -t
```

**Common Causes:**

| Issue | Solution |
|-------|----------|
| Backend not running | `docker-compose up backend -d` |
| Backend crashed | Check logs: `docker-compose logs backend` |
| Wrong upstream config | Verify `upstream backend` in Nginx config points to correct host:port |
| Backend timeout | Increase `proxy_read_timeout` in Nginx config |
| Firewall blocking | Check firewall rules: `sudo ufw status` |

**Restart Nginx:**
```bash
# Test configuration first
sudo nginx -t

# Reload (no downtime)
sudo systemctl reload nginx

# Restart (brief downtime)
sudo systemctl restart nginx
```

---

### 12.5 Performance Issues

**Symptoms:** Slow API responses, high latency.

**Diagnosis:**
```bash
# 1. Check container resource usage
docker stats

# 2. Check database connections
docker exec contravento-db psql -U contravento_user -d contravento -c "
SELECT count(*) FROM pg_stat_activity WHERE datname = 'contravento';
"

# 3. Find slow queries (>1s)
docker exec contravento-db psql -U contravento_user -d contravento -c "
SELECT
  query,
  calls,
  total_time,
  mean_time,
  max_time
FROM pg_stat_statements
WHERE mean_time > 1000
ORDER BY mean_time DESC
LIMIT 10;
"

# 4. Check table sizes
docker exec contravento-db psql -U contravento_user -d contravento -c "
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
"

# 5. Monitor Redis
docker exec contravento-redis redis-cli --no-auth-warning -a YOUR_PASSWORD INFO stats
```

**Solutions:**

**Add database indexes:**
```sql
-- Example: Index on frequently queried columns
CREATE INDEX idx_trips_user_id ON trips(user_id);
CREATE INDEX idx_trips_status ON trips(status);
CREATE INDEX idx_trips_created_at ON trips(created_at DESC);
```

**Optimize queries:**
```python
# Bad: N+1 query problem
trips = await db.execute(select(Trip))
for trip in trips:
    photos = await db.execute(select(TripPhoto).where(TripPhoto.trip_id == trip.id))

# Good: Eager loading
trips = await db.execute(
    select(Trip).options(selectinload(Trip.photos))
)
```

**Scale vertically:**
```bash
# Increase resources in docker-compose.yml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
```

**Scale horizontally:**
```bash
# Increase replicas
services:
  backend:
    deploy:
      replicas: 5  # Increase from 3
```

---

### 12.6 Redis Connection Failed

**Symptoms:** Backend can't connect to Redis.

**Diagnosis:**
```bash
# Check if Redis is running
docker-compose ps redis

# Test Redis connection
docker exec contravento-redis redis-cli --no-auth-warning -a YOUR_PASSWORD ping
# Expected: PONG

# View Redis logs
docker-compose logs redis

# Check Redis info
docker exec contravento-redis redis-cli --no-auth-warning -a YOUR_PASSWORD INFO server
```

**Common Causes:**

| Issue | Solution |
|-------|----------|
| Redis not started | `docker-compose up redis -d` |
| Wrong password | Verify `REDIS_PASSWORD` matches Redis config |
| Network issue | Check Docker network connectivity |
| Redis out of memory | Check memory: `docker exec contravento-redis redis-cli INFO memory` |

**Reset Redis cache:**
```bash
# Flush all keys (âš ï¸  DELETES ALL CACHED DATA)
docker exec contravento-redis redis-cli --no-auth-warning -a YOUR_PASSWORD FLUSHALL

# Restart Redis
docker-compose restart redis
```

---

### 12.7 SSL Certificate Issues

**Symptoms:** HTTPS not working, certificate errors.

**Diagnosis:**
```bash
# Check certificate expiry
openssl s_client -connect api.contravento.com:443 -servername api.contravento.com 2>/dev/null | \
  openssl x509 -noout -dates

# View Certbot logs
docker logs contravento-certbot

# Check Nginx SSL config
sudo nginx -t

# Test SSL configuration
curl -vI https://api.contravento.com
```

**Solutions:**

**Renew certificate manually:**
```bash
# With Certbot installed locally
sudo certbot renew --force-renewal

# With Docker
docker-compose exec certbot certbot renew --force-renewal

# Reload Nginx
sudo systemctl reload nginx
```

**Obtain new certificate:**
```bash
# Local Certbot
sudo certbot --nginx -d api.contravento.com

# Docker Certbot
docker-compose exec certbot certbot certonly \
  --webroot -w /var/www/certbot \
  -d api.contravento.com \
  --email admin@contravento.com \
  --agree-tos
```

**Check auto-renewal:**
```bash
# Verify systemd timer (Ubuntu)
sudo systemctl list-timers | grep certbot

# Test renewal
sudo certbot renew --dry-run
```

---

## 13. Reference

### 13.1 Environment Comparison Matrix

| Feature | SQLite Local | Docker Minimal | Docker Full | Dev | Staging | Production |
|---------|:------------:|:--------------:|:-----------:|:---:|:-------:|:----------:|
| **Deployment Method** | Script | Docker | Docker | Docker | Docker | Docker |
| **Startup Time** | Instant | ~10s | ~30s | ~20s | ~40s | ~60s |
| **RAM Usage** | ~100 MB | ~500 MB | ~1 GB | ~800 MB | ~2 GB | ~3 GB+ |
| **Docker Required** | âŒ | âœ… | âœ… | âœ… | âœ… | âœ… |
| **Database** | SQLite | PostgreSQL | PostgreSQL | PostgreSQL | PostgreSQL | PostgreSQL |
| **Redis** | âŒ | âŒ | âœ… | âœ… | âœ… | âœ… |
| **Nginx** | âŒ | âŒ | âŒ | âœ… | âœ… | âœ… |
| **SSL/TLS** | âŒ | âŒ | âŒ | âŒ | âœ… | âœ… |
| **Email Testing** | Console | Console | MailHog | Real SMTP | Real SMTP | Real SMTP |
| **Database UI** | âŒ | âŒ | pgAdmin | âŒ | âŒ | âŒ |
| **Monitoring** | âŒ | âŒ | âŒ | âŒ | Prometheus+Grafana | Prometheus+Grafana |
| **Hot Reload** | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| **Debug Mode** | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| **Bcrypt Rounds** | 4 | 4 | 4 | 10 | 12 | 14 |
| **Backend Replicas** | 1 | 1 | 1 | 1 | 1 | 3 |
| **Auto-scaling** | âŒ | âŒ | âŒ | âŒ | âŒ | âœ… |
| **Backups** | Manual | Manual | Manual | Manual | Automated | Automated |
| **Best For** | Daily dev | PostgreSQL testing | Email/cache features | Integration testing | Pre-production QA | Live users |

---

### 13.2 Port Reference

| Service | Port | Protocol | Access |
|---------|------|----------|--------|
| **Backend API** | 8000 | HTTP | Public (via Nginx) or localhost |
| **PostgreSQL** | 5432 | TCP | Internal (Docker network) |
| **Redis** | 6379 | TCP | Internal (Docker network) |
| **MailHog Web** | 8025 | HTTP | Localhost (development) |
| **MailHog SMTP** | 1025 | SMTP | Internal (Docker network) |
| **pgAdmin** | 5050 | HTTP | Localhost (development) |
| **Nginx HTTP** | 80 | HTTP | Public (redirects to HTTPS) |
| **Nginx HTTPS** | 443 | HTTPS | Public |
| **Prometheus** | 9090 | HTTP | Localhost (staging/production) |
| **Grafana** | 3000 | HTTP | Localhost (staging/production) |

---

### 13.3 Command Quick Reference

**Deployment:**
```bash
# Start environment
./deploy.sh <env>                    # Linux/Mac
.\deploy.ps1 <env>                   # Windows

# Stop environment
./deploy.sh <env> down

# View logs
./deploy.sh <env> logs

# Restart
./deploy.sh <env> restart
```

**Database:**
```bash
# Apply migrations
docker-compose exec backend alembic upgrade head

# Rollback migration
docker-compose exec backend alembic downgrade -1

# Connect to database
docker exec -it contravento-db psql -U contravento_user -d contravento

# Backup database
docker exec contravento-db pg_dump -U contravento_user contravento > backup.sql

# Restore database
docker exec -i contravento-db psql -U contravento_user contravento < backup.sql
```

**Testing:**
```bash
# Run all tests
docker-compose exec backend pytest

# Run with coverage
docker-compose exec backend pytest --cov=src --cov-report=term

# Run specific test
docker-compose exec backend pytest tests/unit/test_auth_service.py -v
```

**Monitoring:**
```bash
# View logs
docker-compose logs -f backend

# Container stats
docker stats

# Health checks
curl http://localhost:8000/health
docker exec contravento-db pg_isready -U contravento_user
docker exec contravento-redis redis-cli --no-auth-warning -a PASSWORD ping
```

**Secrets:**
```bash
# Generate SECRET_KEY (64 chars)
python -c "import secrets; print(secrets.token_urlsafe(64))"

# Generate password (32 chars)
openssl rand -base64 32

# Generate strong password (48 chars)
openssl rand -base64 48
```

---

### 13.4 Environment Files

| File | Purpose | Tracked in Git |
|------|---------|----------------|
| `.env.dev.example` | Development template | âœ… Yes |
| `.env.local-minimal.example` | Local minimal template | âœ… Yes |
| `.env.local.example` | Local full template | âœ… Yes |
| `.env.dev.example` | Dev environment template | âœ… Yes |
| `.env.staging.example` | Staging template | âœ… Yes |
| `.env.prod.example` | Production template | âœ… Yes |
| `.env` | Active local config | âŒ No (.gitignored) |
| `.env.local-minimal` | Active local minimal config | âŒ No (.gitignored) |
| `.env.local` | Active local full config | âŒ No (.gitignored) |
| `.env.dev` | Active dev config | âŒ No (.gitignored) |
| `.env.staging` | Active staging config | âŒ No (.gitignored) |
| `.env.prod` | Active production config | âŒ No (.gitignored) |

---

### 13.5 Docker Compose Files

| File | Purpose |
|------|---------|
| `docker-compose.yml` | Base configuration (all environments) |
| `docker-compose.local-minimal.yml` | Local minimal overlay (PostgreSQL + Backend) |
| `docker-compose.local.yml` | Local full overlay (+ Redis, MailHog, pgAdmin) |
| `docker-compose.dev.yml` | Dev overlay (+ Nginx, real SMTP) |
| `docker-compose.staging.yml` | Staging overlay (+ SSL, monitoring) |
| `docker-compose.prod.yml` | Production overlay (+ Certbot, HA, auto-scaling) |

---

### 13.6 Migration Files

Located in `backend/migrations/versions/`:

| File | Feature | Description |
|------|---------|-------------|
| `001_initial_auth_schema.py` | User Profiles | Users, profiles, password resets |
| `002_add_privacy_settings.py` | User Profiles | Privacy settings columns |
| `003_stats_and_achievements.py` | User Profiles | Stats and achievements |
| `004_social_features.py` | User Profiles | Follow relationships |
| `005_travel_diary_trips.py` | Travel Diary | Trips, photos, locations, tags |
| `006_trip_tags_association.py` | Travel Diary | Many-to-many trip-tags |

---

### 13.7 Key Documentation

- **Quick Start Guide**: [QUICK_START.md](../../QUICK_START.md)
- **MailHog Setup**: [MAILHOG_SETUP.md](MAILHOG_SETUP.md)
- **Stats Integration**: [STATS_INTEGRATION.md](STATS_INTEGRATION.md)
- **Tags Testing**: [api/TAGS_TESTING.md](api/TAGS_TESTING.md)
- **Docker Deployment Scripts**: [deploy.sh](../../deploy.sh), [deploy.ps1](../../deploy.ps1)
- **Local Development Scripts**: [run-local-dev.sh](../../run-local-dev.sh), [run-local-dev.ps1](../../run-local-dev.ps1)

---

### 13.8 External Resources

**Docker & Infrastructure:**
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [Nginx Documentation](https://nginx.org/en/docs/)
- [Let's Encrypt](https://letsencrypt.org/getting-started/)

**PostgreSQL:**
- [PostgreSQL Documentation](https://www.postgresql.org/docs/16/)
- [PostgreSQL Performance Tuning](https://wiki.postgresql.org/wiki/Performance_Optimization)
- [PostgreSQL Backup & Recovery](https://www.postgresql.org/docs/16/backup.html)

**FastAPI:**
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [FastAPI Deployment Guide](https://fastapi.tiangolo.com/deployment/)
- [Uvicorn Production](https://www.uvicorn.org/deployment/)

**Monitoring:**
- [Prometheus Documentation](https://prometheus.io/docs/)
- [Grafana Documentation](https://grafana.com/docs/)
- [Sentry for FastAPI](https://docs.sentry.io/platforms/python/guides/fastapi/)

**Security:**
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CIS Docker Benchmark](https://www.cisecurity.org/benchmark/docker)
- [Mozilla SSL Configuration Generator](https://ssl-config.mozilla.org/)

---

### 13.9 Support

For issues, questions, or contributions:

- **GitHub Issues**: Report bugs and request features
- **Documentation**: Browse `backend/docs/` directory
- **API Documentation**: Available at `/docs` endpoint (development environments)
- **CLAUDE.md**: Project-specific guidance for Claude Code

---

**Document Version**: 1.0.0
**Last Updated**: 2026-01-08
**Archived Sources**:
- `backend/docs/archive/v0.1.0-DEPLOYMENT.md` (1814 lines)
- `backend/docs/archive/v0.1.0-DOCKER_DEPLOYMENT.md` (861 lines)
