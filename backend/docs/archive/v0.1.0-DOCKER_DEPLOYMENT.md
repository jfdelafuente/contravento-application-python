# [ARCHIVED - v0.1.0] ContraVento - Docker Multi-Environment Deployment Guide

**Archived on**: 2026-01-08
**Reason**: Consolidated with DEPLOYMENT.md into single unified deployment guide
**Replaced by**: [DEPLOYMENT.md](../DEPLOYMENT.md)

---

> ⚠️ **NOTICE**: This document has been archived and may contain outdated information.
> Please refer to the current [DEPLOYMENT.md](../DEPLOYMENT.md) for up-to-date deployment instructions.

---

## Original Content (v0.1.0)

This guide explains how to deploy ContraVento across different environments using Docker Compose with environment-specific overlays.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Environment Types](#environment-types)
3. [Quick Start](#quick-start)
4. [Environment Details](#environment-details)
5. [Configuration Management](#configuration-management)
6. [Deployment Commands](#deployment-commands)
7. [Monitoring and Logging](#monitoring-and-logging)
8. [Troubleshooting](#troubleshooting)
9. [Security Best Practices](#security-best-practices)

---

## Architecture Overview

ContraVento uses a **multi-file Docker Compose approach** with:

- **Base file** (`docker-compose.yml`): Common service definitions
- **Overlay files** (`docker-compose.<env>.yml`): Environment-specific configurations
- **Environment files** (`.env.<env>`): Environment variables

### Service Stack

| Service | Description | Local Minimal | Local Full | Dev | Staging | Prod |
|---------|-------------|:-------------:|:----------:|:---:|:-------:|:----:|
| **postgres** | PostgreSQL 16 database | ✅ | ✅ | ✅ | ✅ | ✅ |
| **backend** | FastAPI application | ✅ | ✅ | ✅ | ✅ | ✅ |
| **redis** | Redis 7 cache | ❌ | ✅ | ✅ | ✅ | ✅ |
| **mailhog** | Email testing | ❌ | ✅ | ❌ | ❌ | ❌ |
| **pgadmin** | Database UI | ❌ | ✅ | ❌ | ❌ | ❌ |
| **nginx** | Reverse proxy | ❌ | ❌ | ✅ | ✅ | ✅ |
| **certbot** | SSL certificates | ❌ | ❌ | ❌ | ❌ | ✅ |
| **prometheus** | Metrics collection | ❌ | ❌ | ❌ | ✅ | ✅ |
| **grafana** | Metrics dashboards | ❌ | ❌ | ❌ | ✅ | ✅ |
| **exporters** | Metrics exporters | ❌ | ❌ | ❌ | ❌ | ✅ |

---

## Environment Types

### 1. LOCAL MINIMAL (Quick Development)

**Purpose**: Minimal local setup for fast development iterations

**Characteristics**:
- ✅ PostgreSQL + Backend only
- ✅ Hot reload for code changes
- ✅ Debug mode enabled
- ✅ Fast startup (2 containers vs 5)
- ✅ Low resource usage
- ✅ Fast bcrypt (4 rounds)
- ✅ Verbose logging
- ❌ No Redis (not needed yet)
- ❌ No MailHog (emails logged to console)
- ❌ No pgAdmin (use external DB tools)

**Use when**: Daily development on trips, stats, profiles, any non-email features

---

### 2. LOCAL FULL (Complete Development)

**Purpose**: Full local development environment with all tools

**Characteristics**:
- ✅ PostgreSQL + Redis + Backend
- ✅ Hot reload for code changes
- ✅ Debug mode enabled
- ✅ MailHog for email testing
- ✅ pgAdmin for database management
- ✅ All ports exposed
- ✅ Fast bcrypt (4 rounds)
- ✅ Verbose logging

**Use when**: Testing auth/email features, implementing cache, prefer visual DB tools

---

### 3. DEV (Integration)

**Purpose**: Integration testing with production-like build

**Characteristics**:
- ✅ Production build (no hot reload)
- ✅ Nginx reverse proxy
- ✅ Real SMTP server
- ❌ No debug mode
- ✅ Moderate bcrypt (10 rounds)
- ✅ Structured logging (JSON)

**Use when**: Testing integrations, CI/CD pipelines, team testing

---

### 4. STAGING (Pre-Production)

**Purpose**: Production mirror for final testing

**Characteristics**:
- ✅ Identical to production
- ✅ Monitoring (Prometheus + Grafana)
- ✅ SSL/TLS
- ✅ Resource limits
- ✅ Automated backups
- ✅ Full security (bcrypt 12)

**Use when**: Final testing before production, client demos, UAT

---

### 5. PROD (Production)

**Purpose**: Live production environment

**Characteristics**:
- ✅ Maximum security (bcrypt 12-14)
- ✅ High availability (3 backend replicas)
- ✅ Auto-scaling
- ✅ Automated SSL renewal
- ✅ Full monitoring stack
- ✅ Log aggregation
- ✅ Automated backups
- ✅ Rate limiting

**Use when**: Serving real users

---

## Quick Start

### Option A: SQLite Development (No Docker) ⚡ FASTEST

**Perfect for daily development - zero configuration!**

```bash
# First-time setup
./run-local-dev.sh --setup      # Linux/Mac
.\run-local-dev.ps1 -Setup      # Windows

# Start server (instant!)
./run-local-dev.sh              # Linux/Mac
.\run-local-dev.ps1             # Windows

# Access
# - Backend API: http://localhost:8000
# - API Docs: http://localhost:8000/docs
```

**Setup automáticamente**:
- ✅ Instala dependencias con Poetry
- ✅ Genera SECRET_KEY
- ✅ Ejecuta migraciones Alembic
- ✅ Crea usuarios de prueba (testuser, maria_garcia)
- ✅ Carga 9 achievements predefinidos

**No Docker needed!** Database stored in `backend/contravento_dev.db`

---

### Option B1: Docker Local Minimal (PostgreSQL + Backend)

**Perfect for testing with PostgreSQL without extra services**

#### Services Included
- ✅ PostgreSQL 16 (database)
- ✅ Backend FastAPI (hot reload)
- ❌ Redis, MailHog, pgAdmin (not included)

#### Quick Start

```bash
# 1. Copy environment file
cp .env.local-minimal.example .env.local-minimal

# 2. Generate SECRET_KEY
python -c "import secrets; print(secrets.token_urlsafe(64))"

# 3. Edit .env.local-minimal and set:
#    - SECRET_KEY (generated above)
#    - POSTGRES_PASSWORD

# 4. Start environment
./deploy.sh local-minimal        # Linux/Mac
.\deploy.ps1 local-minimal       # Windows

# 5. Access
# - Backend API: http://localhost:8000
# - API Docs: http://localhost:8000/docs
# - PostgreSQL: localhost:5432
```

#### When to Use
- Testing PostgreSQL-specific features before staging
- Need PostgreSQL but want minimal resource usage
- Quick database testing without visual tools

---

### Option B2: Docker Local Full (All Development Tools)

**Complete local development with Redis, MailHog, and pgAdmin**

#### Services Included
- ✅ PostgreSQL 16 (database)
- ✅ Redis 7 (cache/sessions)
- ✅ Backend FastAPI (hot reload)
- ✅ MailHog (email testing UI)
- ✅ pgAdmin 4 (database management UI)

#### Quick Start

```bash
# 1. Copy environment file
cp .env.local.example .env.local

# 2. Generate SECRET_KEY
python -c "import secrets; print(secrets.token_urlsafe(64))"

# 3. Edit .env.local and set:
#    - SECRET_KEY (generated above)
#    - POSTGRES_PASSWORD
#    - REDIS_PASSWORD
#    - PGADMIN_PASSWORD

# 4. Start environment
./deploy.sh local                # Linux/Mac
.\deploy.ps1 local               # Windows

# 5. Access
# - Backend API: http://localhost:8000
# - API Docs: http://localhost:8000/docs
# - MailHog UI: http://localhost:8025
# - pgAdmin: http://localhost:5050
# - PostgreSQL: localhost:5432
# - Redis: localhost:6379
```

#### When to Use
- Developing/testing email features (MailHog)
- Implementing cache with Redis
- Prefer visual database tools (pgAdmin)
- Full local integration testing

---

### Option B3: Docker Dev (Integration Testing)

**Production-like build for integration testing**

#### Services Included
- ✅ PostgreSQL 16
- ✅ Redis 7
- ✅ Backend (production build, no hot reload)
- ✅ Nginx reverse proxy
- ✅ Real SMTP server
- ❌ Debug mode, MailHog, pgAdmin

#### Quick Start

```bash
# 1. Copy environment file
cp .env.dev.example .env.dev

# 2. Generate SECRET_KEY
python -c "import secrets; print(secrets.token_urlsafe(64))"

# 3. Edit .env.dev and set:
#    - SECRET_KEY (min 64 chars)
#    - POSTGRES_PASSWORD
#    - REDIS_PASSWORD
#    - SMTP_HOST, SMTP_USER, SMTP_PASSWORD (real SMTP like Mailtrap)

# 4. Start environment
./deploy.sh dev                  # Linux/Mac
.\deploy.ps1 dev                 # Windows

# 5. Access
# - Backend API: http://dev.contravento.local:8000
# - API Docs: http://dev.contravento.local:8000/docs
```

#### Configuration Highlights
```bash
APP_ENV=development
DEBUG=false
BCRYPT_ROUNDS=10              # Moderate security
LOG_FORMAT=json               # Structured logging
```

#### When to Use
- Testing integrations before staging
- CI/CD pipeline testing
- Team collaboration environment
- Validate production build works

---

### Option B4: Docker Staging (Pre-Production)

**Identical to production for final testing**

#### Services Included
- ✅ PostgreSQL 16
- ✅ Redis 7
- ✅ Backend (production build)
- ✅ Nginx reverse proxy
- ✅ SSL/TLS certificates
- ✅ Prometheus (metrics)
- ✅ Grafana (dashboards)
- ✅ Automated backups

#### Quick Start

```bash
# 1. Copy environment file
cp .env.staging.example .env.staging

# 2. Generate strong SECRET_KEY (min 64 chars)
python -c "import secrets; print(secrets.token_urlsafe(96))"

# 3. Edit .env.staging and set:
#    - SECRET_KEY (generated above)
#    - POSTGRES_PASSWORD (min 32 chars)
#    - REDIS_PASSWORD
#    - SMTP_HOST, SMTP_USER, SMTP_PASSWORD
#    - DOMAIN (staging.contravento.com)
#    - GRAFANA_ADMIN_PASSWORD

# 4. Start environment
./deploy.sh staging              # Linux/Mac
.\deploy.ps1 staging             # Windows

# 5. Access
# - Backend API: https://staging.contravento.com
# - Grafana: http://localhost:3000
# - Prometheus: http://localhost:9090
```

#### Configuration Highlights
```bash
APP_ENV=production
DEBUG=false
BCRYPT_ROUNDS=12              # Production-level security
CORS_ORIGINS=https://staging.contravento.com
```

#### When to Use
- Final testing before production release
- Client demos and UAT
- Performance testing under production conditions
- Validate monitoring and alerting

---

### Option B5: Docker Prod (Production)

**Live production environment with high availability**

#### Services Included
- ✅ PostgreSQL 16 (with connection pooling)
- ✅ Redis 7
- ✅ Backend (3 replicas for HA)
- ✅ Nginx reverse proxy
- ✅ Certbot (automated SSL renewal)
- ✅ Prometheus + exporters
- ✅ Grafana
- ✅ Automated backups to external storage
- ✅ Log aggregation

#### Quick Start

```bash
# 1. Copy environment file
cp .env.prod.example .env.prod

# 2. Generate STRONG SECRET_KEY (min 96 chars)
python -c "import secrets; print(secrets.token_urlsafe(128))"

# 3. Generate strong passwords
openssl rand -base64 48  # Database password
openssl rand -base64 32  # Redis password

# 4. Edit .env.prod and set:
#    - SECRET_KEY (min 96 chars)
#    - POSTGRES_PASSWORD (min 48 chars)
#    - REDIS_PASSWORD (min 32 chars)
#    - SMTP_* (production SMTP credentials)
#    - DOMAIN (api.contravento.com)
#    - GRAFANA_ADMIN_PASSWORD
#    - All monitoring/alerting credentials

# 5. Configure external secret manager (recommended)
#    - AWS Secrets Manager
#    - HashiCorp Vault
#    - Azure Key Vault

# 6. Start environment
./deploy.sh prod                 # Linux/Mac
.\deploy.ps1 prod                # Windows

# 7. Verify SSL certificates
curl -I https://api.contravento.com

# 8. Access
# - Backend API: https://api.contravento.com
# - Monitoring: https://monitoring.contravento.com
```

#### Configuration Highlights
```bash
APP_ENV=production
DEBUG=false
BCRYPT_ROUNDS=14              # Maximum security
LOG_LEVEL=WARNING             # Only warnings/errors
# Backend replicas: 3 (high availability)
```

#### Security Checklist
- [ ] All secrets stored in secret manager (not .env files)
- [ ] Firewall configured (only ports 80, 443 exposed)
- [ ] SSL certificates valid and auto-renewing
- [ ] Database backups tested and verified
- [ ] Monitoring alerts configured (email, Slack, PagerDuty)
- [ ] Rate limiting enabled
- [ ] CORS restricted to specific domains (no `*`)

#### When to Use
- Serving real users in production
- Requires 24/7 uptime
- Needs automatic failover and scaling

---

### Docker Deployment Comparison

| Feature | Local Minimal | Local Full | Dev | Staging | Prod |
|---------|:-------------:|:----------:|:---:|:-------:|:----:|
| **Startup time** | ~10s | ~30s | ~20s | ~40s | ~60s |
| **Memory usage** | ~500 MB | ~1 GB | ~800 MB | ~2 GB | ~3 GB |
| **PostgreSQL** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Redis** | ❌ | ✅ | ✅ | ✅ | ✅ |
| **MailHog** | ❌ | ✅ | ❌ | ❌ | ❌ |
| **pgAdmin** | ❌ | ✅ | ❌ | ❌ | ❌ |
| **Nginx** | ❌ | ❌ | ✅ | ✅ | ✅ |
| **SSL/TLS** | ❌ | ❌ | ❌ | ✅ | ✅ |
| **Monitoring** | ❌ | ❌ | ❌ | ✅ | ✅ |
| **Hot reload** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **Debug mode** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **Bcrypt rounds** | 4 | 4 | 10 | 12 | 14 |
| **Replicas** | 1 | 1 | 1 | 1 | 3 |

---

## Environment Details

### LOCAL Environment

#### Files
- `docker-compose.yml` (base)
- `docker-compose.local.yml` (overlay)
- `.env.local` (configuration)

#### Start Command
```bash
# Linux/Mac
./deploy.sh local

# Or manual
docker-compose -f docker-compose.yml -f docker-compose.local.yml --env-file .env.local up -d
```

#### Access Points
| Service | URL | Credentials |
|---------|-----|-------------|
| Backend API | http://localhost:8000 | - |
| API Docs | http://localhost:8000/docs | - |
| MailHog UI | http://localhost:8025 | - |
| pgAdmin | http://localhost:5050 | See `.env.local` |

#### Configuration Highlights
```bash
# .env.local
APP_ENV=local
DEBUG=true
BCRYPT_ROUNDS=4  # Fast for development
LOG_LEVEL=DEBUG
SMTP_HOST=mailhog  # No real emails sent
```

---

### DEV Environment

#### Files
- `docker-compose.yml` (base)
- `docker-compose.dev.yml` (overlay)
- `.env.dev` (configuration)

#### Start Command
```bash
./deploy.sh dev
```

#### Access Points
| Service | URL |
|---------|-----|
| Backend API | http://dev.contravento.local:8000 |
| API Docs | http://dev.contravento.local:8000/docs |

#### Configuration Highlights
```bash
# .env.dev
APP_ENV=development
DEBUG=false
BCRYPT_ROUNDS=10  # Moderate security
LOG_FORMAT=json
SMTP_HOST=smtp.mailtrap.io  # Real SMTP for testing
```

---

### STAGING Environment

#### Files
- `docker-compose.yml` (base)
- `docker-compose.staging.yml` (overlay)
- `.env.staging` (configuration)

#### Start Command
```bash
./deploy.sh staging
```

#### Access Points
| Service | URL | Notes |
|---------|-----|-------|
| Backend API | https://staging.contravento.com | SSL required |
| Grafana | http://localhost:3000 | Monitoring |
| Prometheus | http://localhost:9090 | Metrics |

#### Configuration Highlights
```bash
# .env.staging
APP_ENV=production
DEBUG=false
BCRYPT_ROUNDS=12  # Production-level security
CORS_ORIGINS=https://staging.contravento.com
```

---

### PROD Environment

#### Files
- `docker-compose.yml` (base)
- `docker-compose.prod.yml` (overlay)
- `.env.prod` (configuration)

#### Start Command
```bash
./deploy.sh prod
```

#### Access Points
| Service | URL | Notes |
|---------|-----|-------|
| Backend API | https://api.contravento.com | SSL enforced |
| Monitoring | https://monitoring.contravento.com | Via Nginx proxy |

#### Configuration Highlights
```bash
# .env.prod
APP_ENV=production
DEBUG=false
BCRYPT_ROUNDS=14  # Maximum security
LOG_LEVEL=WARNING  # Only warnings/errors
# Backend replicas: 3 (high availability)
```

---

## Configuration Management

### Environment Variable Precedence

Docker Compose resolves variables in this order (highest to lowest):

1. **Shell environment variables** (`export VAR=value`)
2. **--env-file parameter** (`.env.<env>`)
3. **Default values** (`${VAR:-default}`)

### Security Best Practices

#### 1. Secret Management

**❌ Never commit secrets to git**

```bash
# .gitignore (already configured)
.env
.env.*
!.env.*.example
```

**✅ Use secret management tools for production**:
- AWS Secrets Manager
- HashiCorp Vault
- Azure Key Vault
- Google Secret Manager

#### 2. Generate Strong Keys

```bash
# SECRET_KEY (min 64 chars for production)
python -c "import secrets; print(secrets.token_urlsafe(96))"

# Database password (min 32 chars)
openssl rand -base64 48

# Redis password
openssl rand -base64 32
```

#### 3. Rotate Secrets Regularly

- **Production**: Every 90 days minimum
- **Staging**: Every 180 days
- **Development**: Annually or after security incidents

---

## Deployment Commands

### Using Scripts (Recommended)

```bash
# Start environment
./deploy.sh <env>              # Linux/Mac
.\deploy.ps1 <env>              # Windows

# Stop environment
./deploy.sh <env> down
.\deploy.ps1 <env> down

# View logs (follow mode)
./deploy.sh <env> logs
.\deploy.ps1 <env> logs

# Show running containers
./deploy.sh <env> ps
.\deploy.ps1 <env> ps

# Restart environment
./deploy.sh <env> restart
.\deploy.ps1 <env> restart
```

### Manual Commands

```bash
# Start
docker-compose -f docker-compose.yml -f docker-compose.<env>.yml --env-file .env.<env> up -d

# Stop
docker-compose -f docker-compose.yml -f docker-compose.<env>.yml --env-file .env.<env> down

# Stop and remove volumes (⚠️  DELETES DATA)
docker-compose -f docker-compose.yml -f docker-compose.<env>.yml --env-file .env.<env> down -v

# View logs
docker-compose -f docker-compose.yml -f docker-compose.<env>.yml --env-file .env.<env> logs -f

# Rebuild services
docker-compose -f docker-compose.yml -f docker-compose.<env>.yml --env-file .env.<env> build

# Run database migrations
docker-compose -f docker-compose.yml -f docker-compose.<env>.yml --env-file .env.<env> exec backend poetry run alembic upgrade head
```

---

## Monitoring and Logging

### Viewing Logs

```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f backend

# Last 100 lines
docker-compose logs --tail=100 backend

# Since timestamp
docker-compose logs --since 2024-01-01T00:00:00 backend
```

### Monitoring Stack (Staging/Production)

#### Prometheus
- **URL**: http://localhost:9090 (staging) or https://monitoring.contravento.com/prometheus (prod)
- **Purpose**: Metrics collection
- **Retention**: 30 days

#### Grafana
- **URL**: http://localhost:3000 (staging) or https://monitoring.contravento.com (prod)
- **Purpose**: Metrics visualization
- **Default credentials**: See `.env.<env>` (`GRAFANA_ADMIN_USER/PASSWORD`)

#### Key Metrics
- API response times
- Request rate
- Error rate
- Database connections
- Redis hit/miss ratio
- System resources (CPU, memory, disk)

---

## Troubleshooting

### Common Issues

#### 1. Port Already in Use

```bash
# Check what's using port 8000
lsof -i :8000  # Linux/Mac
netstat -ano | findstr :8000  # Windows

# Change port in .env file
BACKEND_PORT=8001
```

#### 2. Database Connection Failed

```bash
# Check if PostgreSQL is running
docker ps | grep postgres

# View PostgreSQL logs
docker logs contravento-db-<env>

# Test connection
docker exec contravento-db-<env> psql -U <user> -d <database> -c "SELECT 1"

# Check DATABASE_URL matches container credentials
grep DATABASE_URL .env.<env>
```

#### 3. Permission Denied on Scripts

```bash
# Make scripts executable
chmod +x deploy.sh
chmod +x diagnose-postgres.sh
```

#### 4. Containers Not Starting

```bash
# Check for errors
docker-compose logs

# Remove old containers and volumes
docker-compose down -v

# Rebuild from scratch
docker-compose build --no-cache
docker-compose up -d
```

#### 5. SSL Certificate Issues (Production)

```bash
# Check Certbot logs
docker logs contravento-certbot

# Manual certificate renewal
docker-compose exec certbot certbot renew

# Verify certificate
openssl s_client -connect api.contravento.com:443 -servername api.contravento.com
```

---

## Security Best Practices

### Pre-Production Checklist

#### Configuration
- [ ] All passwords are strong (min 32 chars)
- [ ] SECRET_KEY is unique per environment (min 64 chars)
- [ ] DEBUG=false
- [ ] CORS restricted to specific domains (no `*`)
- [ ] SMTP_TLS=true
- [ ] SSL certificates installed and auto-renewing

#### Database
- [ ] PostgreSQL with strong password
- [ ] Automated backups configured and tested
- [ ] Backup restoration tested
- [ ] Database not exposed to public internet

#### Monitoring
- [ ] Prometheus + Grafana configured
- [ ] Alerts configured (email, Slack, PagerDuty)
- [ ] Uptime monitoring enabled
- [ ] Log aggregation configured

#### Security
- [ ] Firewall configured (only ports 80, 443 exposed)
- [ ] Rate limiting enabled
- [ ] File upload validation enabled
- [ ] SQL injection prevention (ORM only)
- [ ] XSS prevention (HTML sanitization)

### Production-Only Checklist

- [ ] High availability (multiple backend replicas)
- [ ] Load balancer configured
- [ ] CDN configured for static assets
- [ ] Automated backups to external storage
- [ ] Disaster recovery plan documented and tested
- [ ] Incident response plan defined
- [ ] On-call rotation established
- [ ] Post-mortem process defined

---

## Additional Resources

- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [PostgreSQL Best Practices](https://wiki.postgresql.org/wiki/Don%27t_Do_This)
- [Redis Best Practices](https://redis.io/docs/management/optimization/)
- [FastAPI Deployment](https://fastapi.tiangolo.com/deployment/)
- [Let's Encrypt](https://letsencrypt.org/)
- [Prometheus](https://prometheus.io/docs/)
- [Grafana](https://grafana.com/docs/)

---

## Support

For issues, questions, or contributions:

- **GitHub Issues**: [github.com/contravento/issues](https://github.com/contravento/issues)
- **Documentation**: See `backend/docs/` directory
- **API Docs**: https://api.contravento.com/docs

---

**Last Updated**: 2026-01-07
