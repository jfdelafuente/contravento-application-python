// ============================================================================
// ContraVento - Jenkins Pipeline
// ============================================================================
// Pipeline for building, testing, and deploying ContraVento application
//
// Prerequisites (Jenkins Credentials):
//   - dockerhub_id: Docker Hub credentials (username + password)
//   - vite_api_url: Frontend API URL (e.g., http://localhost:8000)
//   - vite_turnstile_site_key: Cloudflare Turnstile site key
//
// Stages:
//   1. Run Backend Tests - Execute pytest suite in Docker container
//   2. Build Images - Build backend and frontend Docker images (parallel)
//   3. Push to Docker Hub - Push images to registry
//   4. Deploy to Preproduction - Deploy using docker-compose.preproduction.yml
//   5. Validate Deployment - Run smoke tests and health checks
//
// Note: Git checkout is automatic (done by Jenkins SCM)
// ============================================================================

pipeline {
    agent any

    environment {
        // Docker Hub credentials
        DOCKERHUB_CREDENTIALS = credentials('dockerhub_id')

        // Frontend build arguments
        VITE_API_URL = credentials('vite_api_url')
        VITE_TURNSTILE_SITE_KEY = credentials('vite_turnstile_site_key')

        // Docker image names
        BACKEND_IMAGE = 'jfdelafuente/contravento-backend:latest'
        FRONTEND_IMAGE = 'jfdelafuente/contravento-frontend:latest'

        // Compose file
        COMPOSE_FILE = 'docker compose.preproduction.yml'
    }

    options {
        // Keep only last 10 builds
        buildDiscarder(logRotator(numToKeepStr: '10'))

        // Timeout after 30 minutes
        timeout(time: 30, unit: 'MINUTES')

        // Don't run concurrent builds
        disableConcurrentBuilds()
    }

    stages {
        stage('Run Backend Tests') {
            steps {
                echo '========================================='
                echo 'Stage: Run Backend Tests'
                echo '========================================='

                script {
                    // Run tests inside Python 3.12 Docker container
                    // No need to install Python on Jenkins host
                    echo 'üêç Ejecutando tests en contenedor Docker (python:3.12-slim)'
                    sh 'echo "üìÇ Directorio de trabajo: $(pwd)/backend"'
                    echo 'üì¶ Instalando Poetry y dependencias...'

                    sh '''
                        set -x  # Enable command echoing for debugging

                        echo "=== Iniciando contenedor de tests ==="
                        docker run --rm \
                          -v $(pwd)/backend:/app \
                          -w /app \
                          python:3.12-slim \
                          bash -c "
                            echo 'üì¶ Instalando Poetry...' && \
                            pip install --quiet poetry && \
                            echo '‚úì Poetry instalado' && \
                            \
                            echo 'üì• Instalando dependencias del proyecto...' && \
                            poetry install --no-interaction && \
                            echo '‚úì Dependencias instaladas' && \
                            \
                            echo 'üß™ Ejecutando pytest con coverage...' && \
                            poetry run pytest --cov=src --cov-report=term --cov-report=html -v
                          "

                        echo "=== Tests completados ==="
                    '''

                    echo '‚úÖ Tests ejecutados exitosamente'
                    echo 'üìä Coverage report generado en: backend/htmlcov/'
                }

                echo '‚úÖ Backend Tests Passed'
            }
        }

        stage('Build Docker Images') {
            parallel {
                stage('Build Backend Image') {
                    steps {
                        echo '========================================='
                        echo 'Stage: Build Backend Image'
                        echo '========================================='

                        echo "üê≥ Construyendo imagen: ${BACKEND_IMAGE}"
                        echo 'üìÑ Dockerfile: backend/Dockerfile'
                        echo 'üìÇ Contexto: backend/'

                        sh """
                            set -x
                            docker build -t ${BACKEND_IMAGE} \
                              -f backend/Dockerfile \
                              backend/
                        """

                        echo "‚úÖ Imagen construida: ${BACKEND_IMAGE}"
                    }
                }

                stage('Build Frontend Image') {
                    steps {
                        echo '========================================='
                        echo 'Stage: Build Frontend Image'
                        echo '========================================='

                        echo "üê≥ Construyendo imagen: ${FRONTEND_IMAGE}"
                        echo 'üìÑ Dockerfile: frontend/Dockerfile.prod'
                        echo 'üìÇ Contexto: frontend/'
                        echo 'üîß Build args:'
                        echo "   - VITE_API_URL: ${VITE_API_URL}"
                        echo "   - VITE_TURNSTILE_SITE_KEY: ${VITE_TURNSTILE_SITE_KEY.substring(0, 10)}..."
                        echo '   - VITE_ENV: production'
                        echo '   - VITE_DEBUG: false'

                        sh """
                            set -x
                            docker build -t ${FRONTEND_IMAGE} \
                              --build-arg VITE_API_URL=${VITE_API_URL} \
                              --build-arg VITE_TURNSTILE_SITE_KEY=${VITE_TURNSTILE_SITE_KEY} \
                              --build-arg VITE_ENV=production \
                              --build-arg VITE_DEBUG=false \
                              -f frontend/Dockerfile.prod \
                              frontend/
                        """

                        echo "‚úÖ Imagen construida: ${FRONTEND_IMAGE}"
                    }
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                echo '========================================='
                echo 'Stage: Push to Docker Hub'
                echo '========================================='

                script {
                    // Login to Docker Hub
                    echo "üîê Autenticando en Docker Hub como: ${DOCKERHUB_CREDENTIALS_USR}"
                    sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
                    echo '‚úÖ Login exitoso'

                    // Push backend image
                    echo "üì§ Subiendo imagen backend: ${BACKEND_IMAGE}"
                    sh """
                        set -x
                        docker push ${BACKEND_IMAGE}
                    """
                    echo '‚úÖ Backend image subida correctamente'

                    // Push frontend image
                    echo "üì§ Subiendo imagen frontend: ${FRONTEND_IMAGE}"
                    sh """
                        set -x
                        docker push ${FRONTEND_IMAGE}
                    """
                    echo '‚úÖ Frontend image subida correctamente'
                }

                echo '‚úÖ Todas las im√°genes subidas a Docker Hub'
            }
        }

        stage('Deploy to Preproduction') {
            steps {
                echo '========================================='
                echo 'Stage: Deploy to Preproduction'
                echo '========================================='

                script {
                    echo "üìÑ Archivo docker-compose: ${COMPOSE_FILE}"

                    // Stop any existing containers
                    echo 'üõë Deteniendo contenedores existentes...'
                    sh """
                        set -x
                        docker compose -f ${COMPOSE_FILE} down -v || true
                    """
                    echo '‚úÖ Contenedores detenidos'

                    // Pull latest images
                    echo 'üì• Descargando √∫ltimas im√°genes desde Docker Hub...'
                    sh """
                        set -x
                        docker compose -f ${COMPOSE_FILE} pull
                    """
                    echo '‚úÖ Im√°genes descargadas'

                    // Start services
                    echo 'üöÄ Iniciando servicios de preproducci√≥n...'
                    sh """
                        set -x
                        docker compose -f ${COMPOSE_FILE} up -d
                    """
                    echo '‚úÖ Servicios iniciados'

                    // Wait for services to be healthy
                    echo '‚è≥ Esperando a que los servicios est√©n saludables (30s)...'
                    sh """
                        sleep 30
                        echo 'üìä Estado de los servicios:'
                        docker compose -f ${COMPOSE_FILE} ps
                    """
                }

                echo '‚úÖ Deployment a Preproducci√≥n completado'
                echo 'üåê Acceso:'
                echo '   - Frontend: http://localhost:5173'
                echo '   - Backend API: http://localhost:8000'
                echo '   - API Docs: http://localhost:8000/docs'
                echo '   - pgAdmin: http://localhost:5050'
            }
        }

        stage('Validate Deployment') {
            steps {
                echo '========================================='
                echo 'Stage: Validate Deployment'
                echo '========================================='

                script {
                    // Check backend health
                    echo 'üè• Verificando health check del backend...'
                    echo 'üîó Endpoint: http://localhost:8000/health'
                    sh '''
                        set -x
                        for i in {1..10}; do
                            echo "Intento $i/10..."
                            if curl -f http://localhost:8000/health; then
                                echo '‚úÖ Backend est√° saludable'
                                break
                            else
                                echo "‚è≥ Reintentando en 5 segundos..."
                                sleep 5
                            fi
                        done
                    '''

                    // Check frontend
                    echo 'üåê Verificando accesibilidad del frontend...'
                    echo 'üîó URL: http://localhost:5173'
                    sh '''
                        set -x
                        if curl -f http://localhost:5173; then
                            echo '‚úÖ Frontend es accesible'
                        else
                            echo '‚ùå Frontend no es accesible'
                            exit 1
                        fi
                    '''

                    // Display logs
                    echo 'üìã Mostrando logs recientes del backend:'
                    sh """
                        docker compose -f ${COMPOSE_FILE} logs --tail=50 backend
                    """
                }

                echo '‚úÖ Validaci√≥n del deployment completada exitosamente'
                echo 'üéâ Entorno de preproducci√≥n listo para pruebas'
            }
        }
    }

    post {
        success {
            echo '========================================='
            echo '‚úÖ Pipeline Completed Successfully!'
            echo '========================================='
            echo 'Access preproduction environment:'
            echo '  - Frontend: http://localhost:5173'
            echo '  - Backend API: http://localhost:8000'
            echo '  - API Docs: http://localhost:8000/docs'
            echo '  - pgAdmin: http://localhost:5050'
            echo '========================================='
        }

        failure {
            echo '========================================='
            echo '‚ùå Pipeline Failed!'
            echo '========================================='

            // Display logs for debugging
            sh """
                echo 'Backend logs:'
                docker compose -f ${COMPOSE_FILE} logs --tail=100 backend || true

                echo 'Frontend logs:'
                docker compose -f ${COMPOSE_FILE} logs --tail=100 frontend || true
            """
        }

        always {
            echo 'Cleaning up...'

            // Logout from Docker Hub
            sh 'docker logout || true'

            // Optional: Stop containers after build (comment out if you want to keep them running)
            // sh "docker compose -f ${COMPOSE_FILE} down || true"

            echo 'Cleanup completed'
        }
    }
}
